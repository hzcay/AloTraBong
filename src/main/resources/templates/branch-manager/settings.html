<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title}">Cài đặt Chi nhánh</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    
    <!-- Common Branch Manager Styles -->
    <th:block th:replace="fragments/branch-styles :: branchStyles"></th:block>
    
    <style>
        .page-header {
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 15px;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(255, 107, 53, 0.25);
        }
        
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(255, 107, 53, 0.25);
        }
        
        .settings-section {
            margin-bottom: 30px;
        }
        
        .settings-section h5 {
            color: var(--dark-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .status-active {
            background-color: rgba(40, 167, 69, 0.2);
            color: #155724;
        }
        
        .status-inactive {
            background-color: rgba(220, 53, 69, 0.2);
            color: #721c24;
        }
        
        .shipping-rate-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        
        .shipping-rate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .shipping-rate-title {
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .shipping-rate-body {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        
        .rate-item {
            text-align: center;
        }
        
        .rate-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .rate-value {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
<div class="branch-wrapper">
    <!-- Sidebar -->
    <th:block th:replace="fragments/branch-sidebar :: branchSidebar('settings')"></th:block>
    
    <!-- Main Content -->
    <div class="main-content-wrapper">
        <div class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <h1><i class="bi bi-gear"></i> Cài đặt Chi nhánh</h1>
                <p>Quản lý thông tin và cấu hình chi nhánh</p>
            </div>
            
            <!-- Branch Information -->
            <div class="card-custom">
                <div class="settings-section">
                    <h5><i class="bi bi-building"></i> Thông tin Chi nhánh</h5>
                    
                    <form id="branchInfoForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tên chi nhánh</label>
                                    <input type="text" class="form-control" id="branchName" th:value="${branch.name}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Số điện thoại</label>
                                    <input type="text" class="form-control" id="branchPhone" th:value="${branch.phone}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Địa chỉ</label>
                            <textarea class="form-control" id="branchAddress" rows="3" th:text="${branch.address}"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Giờ mở cửa</label>
                                    <input type="text" class="form-control" id="openHours" placeholder="VD: 7:00 - 22:00">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Trạng thái</label>
                                    <select class="form-select" id="branchStatus">
                                        <option value="true" th:selected="${branch.isActive}">Đang hoạt động</option>
                                        <option value="false" th:selected="${!branch.isActive}">Tạm ngưng</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-primary" onclick="updateBranchInfo()">
                                <i class="bi bi-check"></i> Cập nhật Thông tin
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Shipping Rates -->
            <div class="card-custom">
                <div class="settings-section">
                    <h5><i class="bi bi-truck"></i> Phí Giao hàng</h5>
                    
                    <div id="shippingRatesContainer">
                        <!-- Shipping rates will be loaded here -->
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-primary" onclick="updateShippingRates()">
                            <i class="bi bi-check"></i> Cập nhật Phí Ship
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Branch Statistics -->
            <div class="card-custom">
                <div class="settings-section">
                    <h5><i class="bi bi-graph-up"></i> Thống kê Chi nhánh</h5>
                    
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary" id="totalOrders">0</h4>
                                <p class="text-muted">Tổng đơn hàng</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success" id="totalRevenue">0 ₫</h4>
                                <p class="text-muted">Tổng doanh thu</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info" id="totalShippers">0</h4>
                                <p class="text-muted">Tổng shipper</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning" id="totalItems">0</h4>
                                <p class="text-muted">Tổng sản phẩm</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Shipping Rates Modal -->
<div class="modal fade" id="editShippingRatesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cập nhật Phí Giao hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Phí khởi điểm (₫)</label>
                    <input type="number" class="form-control" id="baseFee" min="0" step="1000">
                </div>
                <div class="mb-3">
                    <label class="form-label">Phí mỗi km (₫)</label>
                    <input type="number" class="form-control" id="perKmFee" min="0" step="1000">
                </div>
                <div class="mb-3">
                    <label class="form-label">Ngưỡng miễn phí ship (₫)</label>
                    <input type="number" class="form-control" id="freeShipThreshold" min="0" step="1000">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="saveShippingRatesBtn">Lưu</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadShippingRates();
        loadBranchStatistics();
    });
    
    function loadShippingRates() {
        fetch('/branch-manager/api/shipping-rates')
            .then(response => response.json())
            .then(rates => {
                displayShippingRates(rates);
            })
            .catch(error => {
                console.error('Error loading shipping rates:', error);
            });
    }
    
    function displayShippingRates(rates) {
        const container = document.getElementById('shippingRatesContainer');
        
        container.innerHTML = `
            <div class="shipping-rate-card">
                <div class="shipping-rate-header">
                    <div class="shipping-rate-title">Cấu hình Phí Giao hàng</div>
                    <button class="btn btn-outline-primary btn-sm" onclick="editShippingRates()">
                        <i class="bi bi-pencil"></i> Chỉnh sửa
                    </button>
                </div>
                
                <div class="shipping-rate-body">
                    <div class="rate-item">
                        <div class="rate-label">Phí khởi điểm</div>
                        <div class="rate-value">${formatMoney(rates.baseFee)}</div>
                    </div>
                    <div class="rate-item">
                        <div class="rate-label">Phí mỗi km</div>
                        <div class="rate-value">${formatMoney(rates.perKmFee)}</div>
                    </div>
                    <div class="rate-item">
                        <div class="rate-label">Miễn phí từ</div>
                        <div class="rate-value">${formatMoney(rates.freeShipThreshold)}</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function editShippingRates() {
        fetch('/branch-manager/api/shipping-rates')
            .then(response => response.json())
            .then(rates => {
                document.getElementById('baseFee').value = rates.baseFee;
                document.getElementById('perKmFee').value = rates.perKmFee;
                document.getElementById('freeShipThreshold').value = rates.freeShipThreshold;
                
                const modal = new bootstrap.Modal(document.getElementById('editShippingRatesModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading shipping rates:', error);
            });
    }
    
    function updateShippingRates() {
        const baseFee = document.getElementById('baseFee').value;
        const perKmFee = document.getElementById('perKmFee').value;
        const freeShipThreshold = document.getElementById('freeShipThreshold').value;
        
        if (!baseFee || !perKmFee || !freeShipThreshold) {
            alert('Vui lòng điền đầy đủ thông tin!');
            return;
        }
        
        const ratesData = {
            baseFee: parseFloat(baseFee),
            perKmFee: parseFloat(perKmFee),
            freeShipThreshold: parseFloat(freeShipThreshold)
        };
        
        fetch('/branch-manager/api/shipping-rates', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(ratesData)
        })
        .then(response => response.json())
        .then(data => {
            alert('Cập nhật phí giao hàng thành công!');
            bootstrap.Modal.getInstance(document.getElementById('editShippingRatesModal')).hide();
            loadShippingRates();
        })
        .catch(error => {
            console.error('Error updating shipping rates:', error);
            alert('Có lỗi xảy ra khi cập nhật phí giao hàng!');
        });
    }
    
    function updateBranchInfo() {
        const branchData = {
            name: document.getElementById('branchName').value,
            phone: document.getElementById('branchPhone').value,
            address: document.getElementById('branchAddress').value,
            openHours: document.getElementById('openHours').value,
            isActive: document.getElementById('branchStatus').value === 'true'
        };
        
        if (!branchData.name || !branchData.phone || !branchData.address) {
            alert('Vui lòng điền đầy đủ thông tin bắt buộc!');
            return;
        }
        
        fetch('/branch-manager/api/branch', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(branchData)
        })
        .then(response => response.json())
        .then(data => {
            alert('Cập nhật thông tin chi nhánh thành công!');
        })
        .catch(error => {
            console.error('Error updating branch info:', error);
            alert('Có lỗi xảy ra khi cập nhật thông tin!');
        });
    }
    
    function loadBranchStatistics() {
        fetch('/branch-manager/api/dashboard')
            .then(response => response.json())
            .then(data => {
                document.getElementById('totalOrders').textContent = data.totalOrders || 0;
                document.getElementById('totalRevenue').textContent = formatMoney(data.monthlyRevenue || 0);
                document.getElementById('totalShippers').textContent = data.totalShippers || 0;
                document.getElementById('totalItems').textContent = '0'; // TODO: Add total items count
            })
            .catch(error => {
                console.error('Error loading branch statistics:', error);
            });
    }
    
    function formatMoney(amount) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(amount);
    }
    
    // Modal event handler
    document.getElementById('saveShippingRatesBtn').addEventListener('click', function() {
        updateShippingRates();
    });
</script>
</body>
</html>
