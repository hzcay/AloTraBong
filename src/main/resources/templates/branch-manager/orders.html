<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title th:text="${title}">Quản lý Đơn hàng</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    
    <!-- Common Branch Manager Styles -->
    <th:block th:replace="fragments/branch-styles :: branchStyles"></th:block>
    
    <style>
        .page-header {
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 15px;
        }
        
        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .filter-tab {
            padding: 8px 16px;
            border: 2px solid #ddd;
            border-radius: 20px;
            text-decoration: none;
            color: #666;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .filter-tab:hover, .filter-tab.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            text-decoration: none;
        }
        
        .order-card {
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .order-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .order-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .order-id {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1em;
        }
        
        .order-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d1ecf1; color: #0c5460; }
        .status-preparing { background: #f8d7da; color: #721c24; }
        .status-ready { background: #d4edda; color: #155724; }
        .status-delivering { background: #cce5ff; color: #004085; }
        .status-delivered { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .status-refunded { background: #e2e3e5; color: #383d41; }
        
        .order-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .order-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 5px 12px;
            font-size: 0.875em;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .order-info {
                grid-template-columns: 1fr;
            }
            
            .order-actions {
                justify-content: center;
            }
            
            .filter-tabs {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
<div class="branch-wrapper">
    <!-- Sidebar -->
    <th:block th:replace="fragments/branch-sidebar :: branchSidebar('orders')"></th:block>
    
    <!-- Main Content -->
    <div class="main-content-wrapper">
        <div class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <h1><i class="bi bi-cart-check"></i> Quản lý Đơn hàng</h1>
                <p>Theo dõi và xử lý đơn hàng của chi nhánh</p>
            </div>
            
            <!-- Statistics Row -->
            <div class="stats-row" id="statsContainer">
                <!-- Stats will be loaded here -->
            </div>
            
            <!-- Filter Tabs -->
            <div class="filter-tabs">
                <a href="#" class="filter-tab active" data-status="" onclick="filterOrders('', this)">
                    <i class="bi bi-list"></i> Tất cả
                </a>
                <a href="#" class="filter-tab" data-status="PENDING" onclick="filterOrders('PENDING', this)">
                    <i class="bi bi-clock"></i> Chờ xử lý
                </a>
                <a href="#" class="filter-tab" data-status="CONFIRMED" onclick="filterOrders('CONFIRMED', this)">
                    <i class="bi bi-check-circle"></i> Đã xác nhận
                </a>
                <a href="#" class="filter-tab" data-status="PREPARING" onclick="filterOrders('PREPARING', this)">
                    <i class="bi bi-gear"></i> Đang chuẩn bị
                </a>
                <a href="#" class="filter-tab" data-status="READY" onclick="filterOrders('READY', this)">
                    <i class="bi bi-box-seam"></i> Sẵn sàng
                </a>
                <a href="#" class="filter-tab" data-status="DELIVERING" onclick="filterOrders('DELIVERING', this)">
                    <i class="bi bi-truck"></i> Đang giao
                </a>
                <a href="#" class="filter-tab" data-status="DELIVERED" onclick="filterOrders('DELIVERED', this)">
                    <i class="bi bi-check2-all"></i> Đã giao
                </a>
                <a href="#" class="filter-tab" data-status="CANCELLED" onclick="filterOrders('CANCELLED', this)">
                    <i class="bi bi-x-circle"></i> Đã hủy
                </a>
            </div>
            
            <!-- Orders List -->
            <div class="card-custom">
                <div class="row align-items-center mb-3">
                    <div class="col">
                        <h5><i class="bi bi-list-ul"></i> Danh sách Đơn hàng</h5>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshOrders()">
                            <i class="bi bi-arrow-clockwise"></i> Làm mới
                        </button>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div id="loadingState" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                    <p class="mt-2 text-muted">Đang tải đơn hàng...</p>
                </div>
                
                <!-- Orders Container -->
                <div id="ordersContainer">
                    <!-- Orders will be loaded here via AJAX -->
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Orders pagination" class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination will be generated here -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Order Detail Modal -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-receipt"></i> Chi tiết Đơn hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <!-- Order detail content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <div id="orderActionButtons">
                    <!-- Action buttons will be added here based on order status -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-arrow-repeat"></i> Cập nhật Trạng thái</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Trạng thái mới</label>
                    <select class="form-select" id="newStatusSelect">
                        <option value="">-- Chọn trạng thái --</option>
                        <option value="CONFIRMED">Xác nhận đơn hàng</option>
                        <option value="PREPARING">Đang chuẩn bị</option>
                        <option value="READY">Sẵn sàng giao hàng</option>
                        <option value="DELIVERING">Đang giao hàng</option>
                        <option value="DELIVERED">Đã giao thành công</option>
                        <option value="CANCELLED">Hủy đơn hàng</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Ghi chú (tùy chọn)</label>
                    <textarea class="form-control" id="statusNote" rows="3" placeholder="Nhập ghi chú về việc thay đổi trạng thái..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="confirmUpdateStatusBtn">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Shipper Modal -->
<div class="modal fade" id="assignShipperModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person-plus"></i> Phân công Shipper</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Chọn Shipper</label>
                    <select class="form-select" id="shipperSelect">
                        <option value="">-- Chọn Shipper --</option>
                    </select>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Chỉ hiển thị các shipper đang hoạt động và có thể nhận đơn mới.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="confirmAssignShipperBtn">Phân công</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentPage = 0;
    let currentStatus = '';
    let currentOrderId = '';
    
    // Load orders on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadOrderStats();
        loadOrders();
        loadShippers();
    });
    
    // Load order statistics
    function loadOrderStats() {
        fetch('/branch-manager/api/orders/stats')
            .then(response => response.json())
            .then(data => {
                const statsHtml = `
                    <div class="stat-card">
                        <div class="stat-number text-primary">${data.totalOrders || 0}</div>
                        <div class="stat-label">Tổng đơn hàng</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number text-warning">${data.pendingOrders || 0}</div>
                        <div class="stat-label">Chờ xử lý</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number text-info">${data.processingOrders || 0}</div>
                        <div class="stat-label">Đang xử lý</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number text-success">${data.completedOrders || 0}</div>
                        <div class="stat-label">Hoàn thành</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number text-danger">${data.cancelledOrders || 0}</div>
                        <div class="stat-label">Đã hủy</div>
                    </div>
                `;
                document.getElementById('statsContainer').innerHTML = statsHtml;
            })
            .catch(error => {
                console.error('Error loading stats:', error);
                document.getElementById('statsContainer').innerHTML = `
                    <div class="col-12 text-center text-muted">
                        <i class="bi bi-exclamation-triangle"></i> Không thể tải thống kê
                    </div>
                `;
            });
    }
    
    // Load orders
    function loadOrders(page = 0) {
        currentPage = page;
        showLoading(true);
        
        const url = `/branch-manager/api/orders?page=${page}&size=10${currentStatus ? '&status=' + currentStatus : ''}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                displayOrders(data.content);
                updatePagination(data);
                showLoading(false);
            })
            .catch(error => {
                console.error('Error loading orders:', error);
                showError('Không thể tải danh sách đơn hàng');
                showLoading(false);
            });
    }
    
    // Display orders
    function displayOrders(orders) {
        const container = document.getElementById('ordersContainer');
        
        if (!orders || orders.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h5>Không có đơn hàng nào</h5>
                    <p class="text-muted">Chưa có đơn hàng nào ${currentStatus ? 'với trạng thái này' : 'trong chi nhánh'}</p>
                </div>
            `;
            return;
        }
        
        const ordersHtml = orders.map(order => `
            <div class="order-card">
                <div class="order-header">
                    <div>
                        <div class="order-id">#${order.orderId}</div>
                        <small class="text-muted">
                            <i class="bi bi-clock"></i> ${formatDateTime(order.createdAt)}
                        </small>
                    </div>
                    <div class="order-status status-${order.status.toLowerCase()}">
                        ${getStatusText(order.status)}
                    </div>
                </div>
                
                <div class="order-info">
                    <div>
                        <strong><i class="bi bi-person"></i> Khách hàng:</strong><br>
                        <span>${order.customerName || 'N/A'}</span><br>
                        <small class="text-muted">${order.customerPhone || ''}</small>
                    </div>
                    <div>
                        <strong><i class="bi bi-geo-alt"></i> Địa chỉ giao hàng:</strong><br>
                        <span>${order.deliveryAddress || 'N/A'}</span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong><i class="bi bi-cash"></i> Tổng tiền:</strong><br>
                        <span class="text-primary fw-bold">${formatCurrency(order.grandTotal)}</span>
                    </div>
                    <div class="col-md-4">
                        <strong><i class="bi bi-credit-card"></i> Thanh toán:</strong><br>
                        <span>${order.paymentMethod || 'N/A'}</span>
                    </div>
                    <div class="col-md-4">
                        <strong><i class="bi bi-truck"></i> Shipper:</strong><br>
                        <span>${order.shipperName || 'Chưa phân công'}</span>
                    </div>
                </div>
                
                <div class="order-actions">
                    <button class="btn btn-outline-primary btn-sm" onclick="viewOrderDetail('${order.orderId}')">
                        <i class="bi bi-eye"></i> Chi tiết
                    </button>
                    ${getOrderActionButtons(order)}
                </div>
            </div>
        `).join('');
        
        container.innerHTML = ordersHtml;
    }
    
    // Get action buttons based on order status
    function getOrderActionButtons(order) {
        let buttons = '';
        
        switch(order.status) {
            case 'PENDING':
                buttons += `
                    <button class="btn btn-success btn-sm" onclick="updateOrderStatus('${order.orderId}', 'CONFIRMED')">
                        <i class="bi bi-check"></i> Xác nhận
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="updateOrderStatus('${order.orderId}', 'CANCELLED')">
                        <i class="bi bi-x"></i> Hủy
                    </button>
                `;
                break;
            case 'CONFIRMED':
                buttons += `
                    <button class="btn btn-info btn-sm" onclick="updateOrderStatus('${order.orderId}', 'PREPARING')">
                        <i class="bi bi-gear"></i> Chuẩn bị
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="showAssignShipperModal('${order.orderId}')">
                        <i class="bi bi-person-plus"></i> Phân công Shipper
                    </button>
                `;
                break;
            case 'PREPARING':
                buttons += `
                    <button class="btn btn-success btn-sm" onclick="updateOrderStatus('${order.orderId}', 'READY')">
                        <i class="bi bi-box-seam"></i> Sẵn sàng
                    </button>
                `;
                break;
            case 'READY':
                if (!order.shipperName) {
                    buttons += `
                        <button class="btn btn-warning btn-sm" onclick="showAssignShipperModal('${order.orderId}')">
                            <i class="bi bi-person-plus"></i> Phân công Shipper
                        </button>
                    `;
                } else {
                    buttons += `
                        <button class="btn btn-primary btn-sm" onclick="updateOrderStatus('${order.orderId}', 'DELIVERING')">
                            <i class="bi bi-truck"></i> Bắt đầu giao
                        </button>
                    `;
                }
                break;
            case 'DELIVERING':
                buttons += `
                    <button class="btn btn-success btn-sm" onclick="updateOrderStatus('${order.orderId}', 'DELIVERED')">
                        <i class="bi bi-check2-all"></i> Đã giao
                    </button>
                `;
                break;
        }
        
        return buttons;
    }
    
    // Filter orders by status
    function filterOrders(status, element) {
        currentStatus = status;
        currentPage = 0;
        
        // Update active tab
        document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
        element.classList.add('active');
        
        loadOrders();
    }
    
    // View order detail
    function viewOrderDetail(orderId) {
        fetch(`/branch-manager/api/orders/${orderId}`)
            .then(response => response.json())
            .then(order => {
                const detailHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-info-circle"></i> Thông tin đơn hàng</h6>
                            <table class="table table-borderless">
                                <tr><td><strong>Mã đơn:</strong></td><td>#${order.orderId}</td></tr>
                                <tr><td><strong>Trạng thái:</strong></td><td><span class="order-status status-${order.status.toLowerCase()}">${getStatusText(order.status)}</span></td></tr>
                                <tr><td><strong>Ngày tạo:</strong></td><td>${formatDateTime(order.createdAt)}</td></tr>
                                <tr><td><strong>Thanh toán:</strong></td><td>${order.paymentMethod}</td></tr>
                                <tr><td><strong>Tổng tiền:</strong></td><td class="text-primary fw-bold">${formatCurrency(order.grandTotal)}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-person"></i> Thông tin khách hàng</h6>
                            <table class="table table-borderless">
                                <tr><td><strong>Tên:</strong></td><td>${order.customerName}</td></tr>
                                <tr><td><strong>SĐT:</strong></td><td>${order.customerPhone}</td></tr>
                                <tr><td><strong>Địa chỉ:</strong></td><td>${order.deliveryAddress}</td></tr>
                            </table>
                            
                            ${order.shipperName ? `
                                <h6><i class="bi bi-truck"></i> Thông tin giao hàng</h6>
                                <table class="table table-borderless">
                                    <tr><td><strong>Shipper:</strong></td><td>${order.shipperName}</td></tr>
                                    <tr><td><strong>SĐT Shipper:</strong></td><td>${order.shipperPhone || 'N/A'}</td></tr>
                                </table>
                            ` : ''}
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6><i class="bi bi-list"></i> Chi tiết sản phẩm</h6>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Sản phẩm</th>
                                    <th>Số lượng</th>
                                    <th>Đơn giá</th>
                                    <th>Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${order.items ? order.items.map(item => `
                                    <tr>
                                        <td>${item.itemName}</td>
                                        <td>${item.quantity}</td>
                                        <td>${formatCurrency(item.unitPrice)}</td>
                                        <td>${formatCurrency(item.totalPrice)}</td>
                                    </tr>
                                `).join('') : '<tr><td colspan="4" class="text-center">Không có thông tin chi tiết</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('orderDetailContent').innerHTML = detailHtml;
                
                // Update action buttons
                const actionButtons = document.getElementById('orderActionButtons');
                actionButtons.innerHTML = getOrderActionButtons(order);
                
                new bootstrap.Modal(document.getElementById('orderDetailModal')).show();
            })
            .catch(error => {
                console.error('Error loading order detail:', error);
                showAlert('Không thể tải chi tiết đơn hàng', 'danger');
            });
    }
    
    // Update order status
    function updateOrderStatus(orderId, newStatus) {
        if (!confirm(`Bạn có chắc chắn muốn cập nhật trạng thái đơn hàng thành "${getStatusText(newStatus)}"?`)) {
            return;
        }
        
        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        
        const headers = {
            'Content-Type': 'application/json'
        };
        
        if (token && header) {
            headers[header] = token;
        }
        
        fetch(`/branch-manager/api/orders/${orderId}/status?status=${newStatus}`, {
            method: 'PUT',
            headers: headers
        })
        .then(response => response.json())
        .then(data => {
            showAlert('Cập nhật trạng thái thành công!', 'success');
            loadOrders(currentPage);
            loadOrderStats();
            
            // Close modals if open
            const modals = ['orderDetailModal', 'updateStatusModal'];
            modals.forEach(modalId => {
                const modalElement = document.getElementById(modalId);
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) modal.hide();
            });
        })
        .catch(error => {
            console.error('Error updating order status:', error);
            showAlert('Không thể cập nhật trạng thái đơn hàng', 'danger');
        });
    }
    
    // Show assign shipper modal
    function showAssignShipperModal(orderId) {
        currentOrderId = orderId;
        new bootstrap.Modal(document.getElementById('assignShipperModal')).show();
    }
    
    // Load shippers
    function loadShippers() {
        fetch('/branch-manager/api/shippers')
            .then(response => response.json())
            .then(shippers => {
                const select = document.getElementById('shipperSelect');
                select.innerHTML = '<option value="">-- Chọn Shipper --</option>';
                
                shippers.filter(s => s.isActive).forEach(shipper => {
                    select.innerHTML += `<option value="${shipper.shipperId}">${shipper.shipperName} - ${shipper.vehiclePlate}</option>`;
                });
            })
            .catch(error => {
                console.error('Error loading shippers:', error);
            });
    }
    
    // Assign shipper
    document.getElementById('confirmAssignShipperBtn').addEventListener('click', function() {
        const shipperId = document.getElementById('shipperSelect').value;
        if (!shipperId) {
            showAlert('Vui lòng chọn shipper', 'warning');
            return;
        }
        
        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        
        const headers = {
            'Content-Type': 'application/json'
        };
        
        if (token && header) {
            headers[header] = token;
        }
        
        fetch(`/branch-manager/api/orders/${currentOrderId}/assign-shipper`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({ shipperId: shipperId })
        })
        .then(response => response.json())
        .then(data => {
            showAlert('Phân công shipper thành công!', 'success');
            loadOrders(currentPage);
            bootstrap.Modal.getInstance(document.getElementById('assignShipperModal')).hide();
        })
        .catch(error => {
            console.error('Error assigning shipper:', error);
            showAlert('Không thể phân công shipper', 'danger');
        });
    });
    
    // Refresh orders
    function refreshOrders() {
        loadOrderStats();
        loadOrders(currentPage);
    }
    
    // Utility functions
    function showLoading(show) {
        document.getElementById('loadingState').style.display = show ? 'block' : 'none';
    }
    
    function showError(message) {
        document.getElementById('ordersContainer').innerHTML = `
            <div class="empty-state">
                <i class="bi bi-exclamation-triangle text-danger"></i>
                <h5>Lỗi</h5>
                <p class="text-muted">${message}</p>
                <button class="btn btn-primary" onclick="refreshOrders()">Thử lại</button>
            </div>
        `;
    }
    
    function updatePagination(data) {
        const pagination = document.getElementById('pagination');
        if (data.totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }
        
        let paginationHtml = '';
        
        // Previous button
        if (data.number > 0) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadOrders(${data.number - 1})">Trước</a></li>`;
        }
        
        // Page numbers
        for (let i = 0; i < data.totalPages; i++) {
            paginationHtml += `<li class="page-item ${i === data.number ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadOrders(${i})">${i + 1}</a>
            </li>`;
        }
        
        // Next button
        if (data.number < data.totalPages - 1) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadOrders(${data.number + 1})">Sau</a></li>`;
        }
        
        pagination.innerHTML = paginationHtml;
    }
    
    function getStatusText(status) {
        const statusMap = {
            'PENDING': 'Chờ xử lý',
            'CONFIRMED': 'Đã xác nhận',
            'PREPARING': 'Đang chuẩn bị',
            'READY': 'Sẵn sàng',
            'DELIVERING': 'Đang giao',
            'DELIVERED': 'Đã giao',
            'CANCELLED': 'Đã hủy',
            'REFUNDED': 'Đã hoàn tiền'
        };
        return statusMap[status] || status;
    }
    
    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(amount);
    }
    
    function formatDateTime(dateString) {
        return new Date(dateString).toLocaleString('vi-VN');
    }
    
    function showAlert(message, type = 'info') {
        // Create and show bootstrap alert
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', alertHtml);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert');
            if (alerts.length > 0) {
                alerts[alerts.length - 1].remove();
            }
        }, 5000);
    }
</script>
</body>
</html>