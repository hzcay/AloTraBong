<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chat Chi nhánh</title>
    <th:block th:replace="~{fragments/branch-styles :: branchStyles}"></th:block>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <style>
        .chat-layout { display:grid; grid-template-columns: 320px 1fr; gap:16px; }
        .chat-list { background:#fff; border-radius:8px; padding:12px; box-shadow:0 1px 6px rgba(0,0,0,.06); }
        .chat-pane { background:#fff; border-radius:8px; padding:12px; box-shadow:0 1px 6px rgba(0,0,0,.06); height:70vh; display:grid; grid-template-rows:auto 1fr auto; }
        .chat-item { padding:10px; border-radius:8px; cursor:pointer; }
        .chat-item.active { background:#fff5ec; }
        .messages { overflow:auto; display:flex; flex-direction:column; gap:8px; }
    </style>
</head>
<body>
<div class="branch-wrapper">
    <th:block th:replace="~{fragments/branch-sidebar :: branchSidebar('chat')}"></th:block>
    <div class="main-content-wrapper">
        <div class="main-content">
            <div class="page-header">
                <h1>Chat Chi nhánh</h1>
                <p>Trao đổi với khách hàng theo phòng chat</p>
            </div>
            <div class="chat-layout">
                <div class="chat-list">
                    <h5>Cuộc trò chuyện</h5>
                    <div id="convo-list" style="display:flex;flex-direction:column;gap:8px"></div>
                </div>
                <div class="chat-pane">
                    <div id="chat-header" style="padding:6px 8px;border-bottom:1px solid #eee">Chưa chọn phòng</div>
                    <div id="messages" class="messages"></div>
                    <form id="send-form" style="display:flex;gap:8px;border-top:1px solid #eee;padding-top:8px">
                        <input id="msg-input" class="form-control" placeholder="Nhập tin nhắn…" autocomplete="off">
                        <button class="btn btn-primary" type="submit">Gửi</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script th:inline="javascript">
  (function(){
    const branchId = /*[[${branchId}]]*/ '';
    const currentUserId = /*[[${currentUserId}]]*/ '';
    window.currentUserId = currentUserId;
    console.log('manager branchId:', branchId);
    const listEl = document.getElementById('convo-list');
    const headerEl = document.getElementById('chat-header');
    const messagesEl = document.getElementById('messages');
    const form = document.getElementById('send-form');
    const input = document.getElementById('msg-input');
    let stomp = null;
    let currentConvo = null;
    let sub = null;

    function connect(){
      if(stomp && stomp.connected) return;
      const sock = new SockJS('/ws');
      stomp = Stomp.over(sock);
      stomp.debug = (s)=>console.log('[STOMP]', s);
      stomp.connect({}, function(){
        console.log('STOMP connected');
      }, (e)=>console.error('CONNECT error', e));
    }

    function subscribe(convoId){
      if(!stomp) connect();
      if(sub) { sub.unsubscribe(); sub = null; }
      // Wait for connection to be established
      const checkAndSubscribe = () => {
        if(stomp && stomp.connected) {
          sub = stomp.subscribe('/topic/conversations.'+convoId, function(frame){
            const msg = JSON.parse(frame.body);
            console.log('Received message:', msg);
            // Chỉ hiển thị tin của đối phương; tin của mình đã hiển thị ngay khi gửi
            if(!msg.senderUserId || msg.senderUserId !== window.currentUserId){
              appendMessage(msg.senderName||'Khách', msg.content||'', false);
            }
          }, (e)=>console.error('SUB error', e));
          console.log('Subscribed to /topic/conversations.'+convoId);
        } else {
          setTimeout(checkAndSubscribe, 100);
        }
      };
      checkAndSubscribe();
    }

    function appendMessage(sender, content, mine){
      const row = document.createElement('div');
      row.style.display='flex';
      row.style.justifyContent = mine ? 'flex-end' : 'flex-start';
      const card = document.createElement('div');
      card.className='card p-2';
      card.style.maxWidth='70%';
      card.textContent = content;
      row.appendChild(card);
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function loadConversations(){
      fetch('/api/chat/conversations/branch?branchId='+encodeURIComponent(branchId))
        .then(r=>r.json())
        .then(list=>{
          console.log('Loaded conversations:', list);
          listEl.innerHTML='';
          list.forEach(c=>{
            const item = document.createElement('div');
            item.className='chat-item';
            const displayName = c.userFullName || c.userEmail || c.userId || 'Khách không tên';
            item.textContent = 'Khách: ' + displayName;
            item.onclick = function(){
              document.querySelectorAll('.chat-item').forEach(x=>x.classList.remove('active'));
              item.classList.add('active');
              currentConvo = c.convoId;
              headerEl.textContent = 'Phòng: ' + displayName;
              messagesEl.innerHTML='';
              subscribe(currentConvo);
              // load history
              fetch('/api/chat/conversations/'+currentConvo+'/messages?page=0&size=30')
                .then(r=>r.json())
                .then(p=>{
                  (p.content||[]).reverse().forEach(m=>{
                    const mine = m.senderUserId && m.senderUserId === window.currentUserId;
                    appendMessage(m.senderName||'', m.content||'', mine);
                  });
                });
            };
            listEl.appendChild(item);
          });
        });
    }

    const CSRF_TOKEN = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

    form.addEventListener('submit', function(e){
      e.preventDefault();
      const txt = (input.value||'').trim();
      if(!txt || !currentConvo) return;
      fetch('/api/chat/conversations/'+currentConvo+'/messages', { method:'POST', headers:Object.assign({'Content-Type':'application/json'}, CSRF_TOKEN?{[CSRF_HEADER]:CSRF_TOKEN}:{}) , body: JSON.stringify({ content: txt })})
        .then(()=>{
          appendMessage('Tôi', txt, true);
          input.value='';
        });
    });

    connect();
    loadConversations();
  })();
</script>
</body>
</html>


