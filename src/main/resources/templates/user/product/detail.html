<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  lang="vi"
  th:replace="~{fragments/layout :: layout(~{::content}, ${product != null ? product.name : 'Chi tiết món'})}">
  <div th:fragment="content">
    <!-- BREADCRUMB -->
    <section class="section" aria-label="Đường dẫn">
      <div class="container center-between breadcrumb-wrap" style="gap:12px">
        <nav class="breadcrumb center" itemscope itemtype="https://schema.org/BreadcrumbList">
          <!-- 1) Trang chủ -->
          <a th:href="@{/}" class="crumb center" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <span class="crumb-icon" aria-hidden="true" style="display:inline-flex">
              <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                <path d="M12 3 3 10h2v9h5v-6h4v6h5v-9h2z" fill="currentColor"/>
              </svg>
            </span>
            <span itemprop="name">Trang chủ</span>
            <meta itemprop="position" content="1"/>
          </a>

          <span class="crumb-sep" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="14" height="14">
              <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
            </svg>
          </span>

          <!-- 2) Menu -->
          <a th:href="@{/menu}" class="crumb" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <span itemprop="name">Menu</span>
            <meta itemprop="position" content="2"/>
          </a>

          <span class="crumb-sep" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="14" height="14">
              <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
            </svg>
          </span>

          <!-- 3) Món hiện tại -->
          <span class="crumb is-current" aria-current="page" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <span class="crumb-current" th:text="${product?.name}">Tên món</span>
            <meta itemprop="position" content="3"/>
          </span>
        </nav>

        <a th:href="@{/menu}" class="btn btn-ghost back-btn center" style="gap:6px">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
            <path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
          </svg>
          <span>Quay lại Menu</span>
        </a>
      </div>
    </section>

    <!-- PRODUCT DETAIL -->
    <section class="section">
      <div class="container grid" style="grid-template-columns: 1.05fr 0.95fr; align-items: start; gap: 28px;">
        <!-- LEFT: MEDIA -->
        <div class="grid" style="gap: 12px">
          <div class="card">
            <img id="pd-main" th:src="${product?.mainImageUrl}" alt="Ảnh chính"
                 onerror="this.onerror=null;this.src='/img/placeholder.jpg'"/>
          </div>

          <div class="grid" style="grid-template-columns: repeat(5, 1fr); gap: 8px"
               th:if="${product != null and product.gallery != null and !#lists.isEmpty(product.gallery)}">
            <button type="button" class="card" style="padding:0;border:none;background:transparent;cursor:pointer"
                    th:each="m : ${product.gallery}" th:attr="data-src=${m.url}">
              <img th:src="${m.thumbnailUrl != null ? m.thumbnailUrl : m.url}" alt="Thumb"
                   onerror="this.onerror=null;this.src='/img/placeholder.jpg'"/>
            </button>
          </div>
        </div>

        <!-- RIGHT -->
        <article>
          <h1 class="m-0 mb-2 bold" style="font-size:28px" th:text="${product?.name}">Tên món</h1>

          <div class="center" style="gap:10px;justify-content:flex-start" th:if="${product?.rating != null}">
            <div title="Đánh giá trung bình">⭐ <b th:text="${#numbers.formatDecimal(product.rating,1,1)}">4.8</b></div>
            <span class="text-muted">|</span>
            <a href="#reviews" class="text-muted" th:text="${product?.reviewCount + ' đánh giá'}">12 đánh giá</a>
          </div>

          <div class="mb-2" style="margin-top:10px">
            <strong style="font-size:22px"
                    th:text="${product != null && product.price != null ? #numbers.formatDecimal(product.price,0,0) + 'đ' : 'Liên hệ'}">
              59.000đ
            </strong>
            <span class="badge" th:if="${product?.isBestSeller}">Bán chạy</span>
            <span class="badge" th:if="${product?.isNew}">Mới</span>
            <span class="badge" th:if="${product?.isFavorite}">Yêu thích</span>
          </div>

          <p class="text-muted mb-3" th:text="${product?.shortDesc}">
            Mô tả ngắn gọn món ăn, khẩu vị, thành phần nổi bật…
          </p>

          <!-- CTA -->
          <div class="center" style="gap:10px;justify-content:flex-start" th:if="${product?.available}">
            <form th:action="@{/user/cart}" method="post" class="center" style="gap:10px">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              <!-- ĐÚNG TÊN THAM SỐ -->
              <input type="hidden" name="itemId" th:value="${product?.id}" />
              <!-- Lấy branchId từ query ?branchId=..., nếu không có thì fallback 'b1' -->
              <input type="hidden" name="branchId" th:value="${param.branchId != null ? param.branchId : 'b1'}" />
              <input class="input" type="number" name="quantity" value="1" min="1" style="max-width:110px" />
              <button class="btn btn-primary" type="submit">+ Thêm vào giỏ</button>
            </form>
            <form th:action="@{/favorites}" method="post">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              <input type="hidden" name="productId" th:value="${product?.id}" />
              <button class="btn" type="submit" title="Thêm vào yêu thích">❤️</button>
            </form>
          </div>
          <div th:if="${product != null and !product.available}" class="text-muted">
            Tạm hết hàng tại chi nhánh này.
          </div>

          <!-- TABS -->
          <div class="mb-2" style="margin-top:18px;border-bottom:1px solid var(--line);display:flex;gap:14px;">
            <button type="button" class="tab is-active" data-tab="desc">Mô tả</button>
            <button type="button" class="tab" data-tab="nutri"
                    th:if="${product != null and product['nutrition'] != null}">Dinh dưỡng</button>
            <button type="button" class="tab" data-tab="reviews">Đánh giá</button>
          </div>

          <!-- Panel: Mô tả -->
          <div data-panel="desc">
            <p th:utext="${product?.longDesc}">Nội dung mô tả chi tiết món…</p>
          </div>

          <!-- Panel: Dinh dưỡng -->
          <div data-panel="nutri" hidden th:if="${product != null and product['nutrition'] != null}">
            <div class="grid" style="grid-template-columns: repeat(2, 1fr)">
              <div class="card pad">
                <div class="center-between"><span>Năng lượng</span><b th:text="${product['nutrition']['cal']} + ' kcal'">350 kcal</b></div>
                <div class="center-between"><span>Đạm</span><b th:text="${product['nutrition']['protein']} + ' g'">12 g</b></div>
                <div class="center-between"><span>Béo</span><b th:text="${product['nutrition']['fat']} + ' g'">15 g</b></div>
                <div class="center-between"><span>Carb</span><b th:text="${product['nutrition']['carb']} + ' g'">28 g</b></div>
                <div class="center-between"><span>Natri</span><b th:text="${product['nutrition']['sodium']} + ' mg'">420 mg</b></div>
              </div>
              <div class="card pad">
                <p class="m-0 text-muted">* Thông tin có thể thay đổi theo chi nhánh / thời điểm.</p>
              </div>
            </div>
          </div>

          <!-- Panel: Đánh giá -->
          <div data-panel="reviews" id="reviews" hidden>
            <div class="center-between mb-2">
              <h3 class="m-0 bold">Đánh giá từ khách hàng</h3>
              <a th:href="@{'/user/review/write'(itemId=${product?.id})}" class="btn">Viết đánh giá</a>
            </div>
            <div class="grid" style="gap: 12px">
              <article class="card pad" th:each="rv : ${reviews}">
                <div class="center-between mb-1">
                  <div class="center" style="gap: 8px; justify-content: flex-start">
                    <div class="avatar" th:text="${#strings.substring(rv.userName,0,1)}">U</div>
                    <div>
                      <b th:text="${rv.userName}">User</b>
                      <div class="text-muted" th:text="${#temporals.format(rv.createdAt, 'dd/MM/yyyy HH:mm')}">12/10/2025 12:21</div>
                    </div>
                  </div>
                  <div title="Điểm">⭐ <b th:text="${rv.rating}">5</b>/5</div>
                </div>
                <p th:text="${rv.content}">Nội dung đánh giá…</p>
                <div class="grid" style="grid-template-columns: repeat(5, 1fr); gap: 8px"
                     th:if="${rv.media != null and !#lists.isEmpty(rv.media)}">
                  <a class="card" th:each="m : ${rv.media}" th:href="${m.url}" target="_blank" rel="noopener">
                    <img th:src="${m.thumbnailUrl != null ? m.thumbnailUrl : m.url}" alt=""
                         onerror="this.onerror=null;this.src='/img/placeholder.jpg'"/>
                  </a>
                </div>
              </article>
              <div th:if="${reviews == null or #lists.isEmpty(reviews)}" class="text-muted p-2">
                Chưa có đánh giá. Hãy là người đầu tiên!
              </div>
            </div>
          </div>
        </article>
      </div>
    </section>

    <!-- RELATED -->
    <section class="section" th:if="${related != null and !#lists.isEmpty(related)}">
      <div class="container">
        <header class="section-head">
          <h2 class="section-title">Món tương tự</h2>
          <a th:href="@{/menu}" class="btn">Xem Menu</a>
        </header>

        <div class="grid grid-4">
          <article class="card pad" th:each="p : ${related}">
            <img th:src="${p.thumbnailUrl}" alt="" onerror="this.onerror=null;this.src='/img/placeholder.jpg'"/>
            <h3 class="m-0 mb-1 bold" th:text="${p.name}">Tên món</h3>
            <div class="center-between">
              <strong th:text="${p.price != null ? #numbers.formatDecimal(p.price,0,0) + 'đ' : 'Liên hệ'}">49.000đ</strong>
              <div class="center" style="gap: 8px">
                <form th:action="@{/favorites}" method="post">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                  <input type="hidden" name="productId" th:value="${p.id}" />
                  <button class="btn" type="submit" title="Yêu thích">❤️</button>
                </form>
                <!-- Thêm giỏ (ĐÃ SỬA) -->
                <form th:action="@{/user/cart}" method="post">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                  <input type="hidden" name="itemId" th:value="${p.id}" />
                  <input type="hidden" name="branchId" th:value="${param.branchId != null ? param.branchId : 'b1'}" />
                  <input type="hidden" name="quantity" value="1" />
                  <button class="btn" type="submit">+ Giỏ</button>
                </form>
              </div>
            </div>
            <a th:href="@{'/p/' + ${p.slug}}" class="text-muted">Xem chi tiết →</a>
          </article>
        </div>
      </div>
    </section>

    <!-- JS -->
    <script>
      (function () {
        const tabs = Array.from(document.querySelectorAll(".tab"));
        const panels = {
          desc: document.querySelector('[data-panel="desc"]'),
          nutri: document.querySelector('[data-panel="nutri"]'),
          reviews: document.querySelector('[data-panel="reviews"]'),
        };
        tabs.forEach((t) => {
          if (!t.type) t.type = "button";
          t.addEventListener("click", () => {
            tabs.forEach((x) => x.classList.remove("is-active"));
            t.classList.add("is-active");
            Object.values(panels).forEach((p) => p && (p.hidden = true));
            const key = t.dataset.tab;
            if (panels[key]) panels[key].hidden = false;
          });
        });

        const main = document.querySelector("#pd-main");
        document.querySelectorAll("[data-src]").forEach((b) => {
          b.addEventListener("click", () => { if (main) main.src = b.dataset.src; });
        });
      })();
    </script>
  </div>
</html>
