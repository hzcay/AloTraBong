<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi"
      th:replace="~{fragments/layout :: layout(~{::content}, 'Lịch sử đơn hàng')}">
<div th:fragment="content">

  <section class="section">
    <div class="container">
      <header class="section-head">
        <h2 class="section-title m-0">Lịch sử đơn hàng</h2>

        <!-- Filter theo trạng thái + thời gian -->
        <form th:action="@{/orders}" method="get" class="center" style="gap:8px;flex-wrap:wrap">
          <select class="select" name="status" th:value="${status}">
            <option value="">Tất cả trạng thái</option>
            <option value="NEW" th:selected="${status=='NEW'}">Mới</option>
            <option value="CONFIRMED" th:selected="${status=='CONFIRMED'}">Đã xác nhận</option>
            <option value="SHIPPING" th:selected="${status=='SHIPPING'}">Đang giao</option>
            <option value="DELIVERED" th:selected="${status=='DELIVERED'}">Đã giao</option>
            <option value="CANCELLED" th:selected="${status=='CANCELLED'}">Hủy</option>
            <option value="REFUNDED" th:selected="${status=='REFUNDED'}">Hoàn tiền</option>
          </select>

          <input class="input" type="date" name="from" th:value="${from}">
          <input class="input" type="date" name="to" th:value="${to}">
          <button class="btn" type="submit">Lọc</button>
          <a class="btn" th:href="@{/orders}">Xóa lọc</a>
        </form>
      </header>

      <!-- Empty -->
      <div th:if="${#lists.isEmpty(page?.content)}" class="card pad text-muted">
        Chưa có đơn nào. <a th:href="@{/menu}">Đặt món ngay →</a>
      </div>

      <!-- List đơn -->
      <div class="grid" style="gap:12px" th:if="${!#lists.isEmpty(page?.content)}">
        <article class="card pad" th:each="o : ${page.content}">
          <div class="center-between mb-1">
            <div class="center" style="gap:12px;justify-content:flex-start">
              <b>#<span th:text="${o.code}">ALB12345</span></b>
              <span class="text-muted" th:text="${#temporals.format(o.createdAt,'dd/MM/yyyy HH:mm')}">25/10/2025 12:00</span>
              <span class="text-muted">•</span>
              <span class="text-muted" th:text="${o.branchName}">Chi nhánh X</span>
            </div>

            <!-- tag trạng thái -->
            <div th:switch="${o.status}">
              <div th:case="'NEW'"       class="tag tag-new">MỚI</div>
              <div th:case="'CONFIRMED'" class="tag tag-confirm">ĐÃ XÁC NHẬN</div>
              <div th:case="'SHIPPING'"  class="tag tag-ship">ĐANG GIAO</div>
              <div th:case="'DELIVERED'" class="tag tag-done">ĐÃ GIAO</div>
              <div th:case="'CANCELLED'" class="tag tag-cancel">HỦY</div>
              <div th:case="'REFUNDED'"  class="tag tag-refund">HOÀN TIỀN</div>
              <div th:case="*"
                   class="badge">Trạng thái khác</div>
            </div>
          </div>

          <!-- items rút gọn -->
          <div class="grid" style="gap:8px">
            <div class="center-between" th:each="it,iter : ${o.items}">
              <div class="center" style="gap:8px;justify-content:flex-start">
                <div class="card" style="width:44px;height:44px;overflow:hidden">
                  <img th:src="${it.thumbnailUrl}" alt="" style="width:100%;height:100%;object-fit:cover">
                </div>
                <div>
                  <b th:text="${it.name}">Tên món</b>
                  <div class="text-muted"><span th:text="${it.qty}">1</span> x <span th:text="${#numbers.formatInteger(it.unitPrice)} + 'đ'">0đ</span></div>
                </div>
              </div>
              <b th:text="${#numbers.formatInteger(it.subtotal)} + 'đ'">0đ</b>
            </div>
          </div>

          <!-- total + actions -->
          <div class="center-between" style="margin-top:10px;border-top:1px solid var(--line);padding-top:10px">
            <div class="text-muted">Tổng: <b th:text="${#numbers.formatInteger(o.grandTotal)} + 'đ'">0đ</b></div>
            <div class="center" style="gap:8px">
              <a th:href="@{'/orders/' + ${o.code}}" class="btn">Xem chi tiết</a>
              <a th:if="${o.status=='DELIVERED'}"
                 th:href="@{'/review/write'(orderCode=${o.code})}" class="btn">Đánh giá món</a>
              <a th:if="${o.status=='NEW' || o.status=='CONFIRMED'}"
                 th:href="@{'/orders/' + ${o.code} + '/cancel'}" class="btn">Hủy đơn</a>
            </div>
          </div>
        </article>
      </div>

      <!-- Pagination -->
      <div th:if="${page?.totalPages > 1}" class="center" style="gap:8px;margin-top:16px">
        <a class="btn" th:if="${!page.first}"
           th:href="@{/orders(page=${page.number-1}, status=${status}, from=${from}, to=${to})}">← Trước</a>
        <span>Trang <b th:text="${page.number+1}">1</b>/<b th:text="${page.totalPages}">1</b></span>
        <a class="btn" th:if="${!page.last}"
           th:href="@{/orders(page=${page.number+1}, status=${status}, from=${from}, to=${to})}">Sau →</a>
      </div>
    </div>
  </section>

</div>
</html>
