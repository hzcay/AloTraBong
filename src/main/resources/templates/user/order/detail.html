<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      lang="vi"
      th:replace="~{fragments/layout :: layout(~{::content}, 'Chi tiết đơn hàng')}">
<div th:fragment="content">

  <section class="section">
    <div class="container" style="max-width:800px;margin:auto">
      <!-- ===== STYLE CHO STATUS TAG ===== -->
      <style>
        .tag {
          display: inline-block;
          padding: 4px 10px;
          border-radius: 8px;
          font-size: 0.85rem;
          font-weight: 600;
          text-transform: none;
          letter-spacing: 0.3px;
        }
        .tag-pending { background: #fef3c7; color: #92400e; }
        .tag-confirm { background: #dbeafe; color: #1e40af; }
        .tag-prep    { background: #fde68a; color: #78350f; }
        .tag-ready   { background: #dcfce7; color: #166534; }
        .tag-ship    { background: #e0f2fe; color: #075985; }
        .tag-done    { background: #bbf7d0; color: #14532d; }
        .tag-cancel  { background: #fee2e2; color: #991b1b; }
        .tag-refund  { background: #fef9c3; color: #854d0e; }
        .tag-other   { background: #e5e7eb; color: #374151; }
      </style>

      <!-- TH: lỗi / không tìm thấy đơn / không có quyền -->
      <div th:if="${error != null}"
           class="card pad"
           style="border:1px solid var(--line); background:#fff3cd; color:#664d03; margin-bottom:16px;">
        <b th:text="${error}">
          Không tìm thấy đơn hàng hoặc bạn không có quyền xem.
        </b>
        <div style="margin-top:8px">
          <a class="btn" th:href="@{/user/order/history}">← Về lịch sử đơn</a>
        </div>
      </div>

      <!-- TH: có dữ liệu order -->
      <div th:if="${order != null}">

        <!-- ====== Thông tin đơn hàng / trạng thái / nút hủy ====== -->
        <div class="card pad" style="margin-bottom:16px">
          <div class="center-between" style="flex-wrap:wrap;row-gap:8px">

            <!-- Cột trái: info -->
            <div style="display:flex; flex-direction:column; gap:4px; font-size:.9rem; line-height:1.4">
              <div>
                <b>Mã đơn:</b>
                <span th:text="${order.code}">ALB12345</span>
              </div>

              <div>
                <b>Thời gian đặt:</b>
                <span th:text="${#temporals.format(order.createdAt,'dd/MM/yyyy HH:mm')}">
                  25/10/2025 12:00
                </span>
              </div>

              <div>
                <b>Chi nhánh:</b>
                <span th:text="${order.branchName}">Chi nhánh ABC</span>
              </div>

              <div th:if="${order.deliveryAddress != null}">
                <b>Giao tới:</b>
                <span th:text="${order.deliveryAddress}">123 Lê Lợi, Q.1</span>
              </div>

              <div th:if="${order.customerNote != null}">
                <b>Ghi chú:</b>
                <span th:text="${order.customerNote}">Ít đá, ít cay</span>
              </div>

              <div th:if="${order.paymentMethod != null}">
                <b>Thanh toán:</b>
                <span th:text="${order.paymentMethod}">Tiền mặt</span>
                <span th:if="${order.paymentStatus != null}"
                      class="payment-status"
                      th:classappend="${order.paymentStatus == 'PAID'} ? 'paid' : 'unpaid'"
                      th:text="'(' + ${order.paymentStatus} + ')'">
                  (UNPAID)
                </span>
              </div>
            </div>

            <!-- Cột phải: trạng thái + action -->
            <div style="text-align:right; display:flex; flex-direction:column; align-items:flex-end; row-gap:8px">

              <!-- badge trạng thái -->
              <div th:switch="${order.status}">
                <div th:case="'PENDING'"      class="tag tag-pending">Chờ xác nhận</div>
                <div th:case="'CONFIRMED'"    class="tag tag-confirm">Đã xác nhận</div>
                <div th:case="'PREPARING'"    class="tag tag-prep">Đang làm món</div>
                <div th:case="'READY'"        class="tag tag-ready">Sẵn sàng lấy</div>
                <div th:case="'DELIVERING'"   class="tag tag-ship">Đang giao</div>
                <div th:case="'DELIVERED'"    class="tag tag-done">Đã giao</div>
                <div th:case="'RECEIVED'"    class="tag tag-done">Đã nhận</div>
                <div th:case="'CANCELLED'"    class="tag tag-cancel">Đã hủy</div>
                <div th:case="'REFUNDED'"     class="tag tag-refund">Hoàn tiền</div>
                <div th:case="*"
                     class="tag tag-other"
                     th:text="${order.status}">
                  KHÁC
                </div>
              </div>

              <!-- nút hủy đơn (chỉ show nếu còn hủy đc) -->
              <a class="btn"
                 th:if="${order.cancellable}"
                 th:href="@{'/user/order/detail/' + ${order.code} + '?action=cancel'}">
                Hủy đơn
              </a>
            </div>

          </div>
        </div>

        <!-- ====== Popup / block confirm hủy (bật khi ?action=cancel) ====== -->
        <div th:if="${cancelMode}"
             class="card pad"
             style="border:1px solid #f5c2c7; background:#f8d7da; color:#842029; margin-bottom:16px;">
          <b>Hủy đơn hàng?</b>
          <div style="font-size:.9rem; line-height:1.4; margin-top:4px;">
            Sau khi hủy, đơn sẽ không được chuẩn bị nữa.
          </div>

          <form th:action="@{'/user/order/' + ${order.code} + '/cancel'}"
                method="post"
                style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">

            <button class="btn" type="submit"
                    style="background:#842029;color:#fff;border:1px solid #842029;">
              Xác nhận hủy đơn
            </button>

            <a class="btn"
               th:href="@{'/user/order/detail/' + ${order.code}}"
               style="background:#fff;border:1px solid var(--line);color:inherit;">
              Thoát
            </a>
          </form>
        </div>

        <!-- ====== Danh sách món trong đơn ====== -->
        <div class="card pad" style="margin-bottom:16px">
          <h3 style="margin-top:0;margin-bottom:12px;font-size:1rem;font-weight:600">
            Món đã gọi
          </h3>

          <div class="grid" style="gap:12px">
            <div class="center-between"
                 th:each="it : ${order.items}"
                 style="align-items:flex-start">

              <div class="center" style="gap:12px;justify-content:flex-start">
                <!-- thumbnail -->
                <div class="card" style="width:56px;height:56px;overflow:hidden;flex-shrink:0;">
                  <img th:src="${it.thumbnailUrl}" alt=""
                       style="width:100%;height:100%;object-fit:cover">
                </div>

                <!-- info món -->
                <div style="display:flex;flex-direction:column;row-gap:4px;font-size:.9rem;line-height:1.4">
                  <b th:text="${it.name}">Tên món</b>

                  <div class="text-muted">
                    <span th:text="${it.qty}">1</span>
                    x
                    <span th:text="${@vnd.format(it.unitPrice)}">0 đ</span>
                  </div>
                </div>
              </div>

              <!-- Tổng tiền dòng -->
              <div style="text-align:right;font-weight:600;white-space:nowrap;font-size:.9rem;">
                <span th:text="${@vnd.format(it.lineTotal)}">0 đ</span>
              </div>

            </div>
          </div>
        </div>

        <!-- ====== Tổng kết tiền + Thông tin giao hàng / ghi chú ====== -->
        <div class="card pad">
          <h3 style="margin-top:0;margin-bottom:12px;font-size:1rem;font-weight:600">
            Thanh toán
          </h3>

          <div style="display:flex;flex-direction:column;row-gap:6px;font-size:.95rem">

            <div class="center-between">
              <span>Tạm tính</span>
              <b th:text="${@vnd.format(order.subtotal)}">0 đ</b>
            </div>

            <div class="center-between"
                th:if="${order.discount != null and order.discount.compareTo(T(java.math.BigDecimal).ZERO) > 0}">
              <span>Giảm giá</span>
              <b th:text="'-' + ${@vnd.format(order.discount)}">-0 đ</b>
            </div>

            <div class="center-between" th:if="${order.shippingFee != null}">
              <span>Phí giao hàng</span>
              <b th:text="${@vnd.format(order.shippingFee)}">15.000 đ</b>
            </div>

            <div class="center-between"
                 style="border-top:1px solid var(--line);padding-top:8px;margin-top:4px">
              <span>Tổng thanh toán</span>
              <b style="font-size:1.1rem"
                 th:text="${@vnd.format(order.grandTotal)}">0 đ</b>
            </div>
          </div>
          <div style="margin-top:16px">
            <a class="btn" th:href="@{/user/order/history}">← Quay lại lịch sử</a>
          </div>
        </div>

      </div> <!-- /if order != null -->

    </div>
  </section>

</div>
</html>
