<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  lang="vi"
  th:replace="~{fragments/layout :: layout(~{::content}, 'Danh sách chi nhánh')}"
>
<div th:fragment="content">

  <section class="section">
    <div class="container">
      <header class="section-head">
        <h2 class="section-title m-0">Chi nhánh AloTraBong</h2>

        <form th:action="@{/branches}" method="get" class="center" style="gap:8px;flex-wrap:wrap">
          <input class="input" type="text" name="q" th:value="${q}" placeholder="Tìm theo tên/địa chỉ...">
          <select class="select" name="city" th:value="${city}">
            <option value="">Tất cả tỉnh/thành</option>
            <option th:each="c : ${cities}" th:value="${c}" th:text="${c}"
                    th:selected="${city == c}"></option>
          </select>
          <select class="select" name="status" th:value="${status}">
            <option value="">Mọi trạng thái</option>
            <option value="OPEN" th:selected="${status=='OPEN'}">Đang mở cửa</option>
            <option value="CLOSED" th:selected="${status=='CLOSED'}">Đóng cửa</option>
          </select>
          <button class="btn" type="submit">Lọc</button>
          <a class="btn" th:href="@{/branches}">Xóa lọc</a>
        </form>
      </header>

      <!-- Map (tuỳ chọn) -->
      <div class="card" style="height:280px;margin-bottom:14px;display:flex;align-items:center;justify-content:center">
        <span class="text-muted">[Nhúng bản đồ chi nhánh ở đây nếu cần]</span>
      </div>

      <!-- Empty -->
      <div th:if="${#lists.isEmpty(branches)}" class="card pad text-muted">
        Không tìm thấy chi nhánh phù hợp.
      </div>

      <!-- Grid branches -->
      <div class="grid grid-3" th:if="${!#lists.isEmpty(branches)}">
        <article class="card pad" th:each="b : ${branches}">
          <div class="center-between mb-1">
            <h3 class="m-0 bold" th:text="${b.name}">AloTraBong - Quận 1</h3>
            <span th:classappend="${b.openNow} ? 'tag tag-confirm' : 'tag tag-cancel'"
                  th:text="${b.openNow ? 'Mở cửa' : 'Đóng cửa'}">Mở cửa</span>
          </div>

          <div class="text-muted mb-1" th:text="${b.address}">12 Nguyễn Huệ, Q.1, TP.HCM</div>
          <div class="mb-1">
            Hotline: <b th:text="${b.phone}">0123 456 789</b>
          </div>

          <div class="grid" style="gap:6px">
            <div class="center-between">
              <span class="text-muted">Giờ mở cửa hôm nay</span>
              <b th:text="${b.todayOpenHour} ?: '08:00 - 22:00'">08:00 - 22:00</b>
            </div>
            <div class="center-between" th:if="${b.distanceKm != null}">
              <span class="text-muted">Khoảng cách</span>
              <b th:text="${#numbers.formatDecimal(b.distanceKm, 1, 1)} + ' km'">1.2 km</b>
            </div>
            <div class="center-between" th:if="${b.deliveryEtaMin != null}">
              <span class="text-muted">Ước tính giao</span>
              <b th:text="${b.deliveryEtaMin} + ' phút'">25 phút</b>
            </div>
          </div>

          <div class="center" style="gap:8px;justify-content:flex-start;margin-top:10px">
            <a th:href="@{'/menu'(branchId=${b.id})}" class="btn btn-primary">Xem menu</a>
            <form th:action="@{'/branches/' + ${b.id} + '/set-default'}" method="post">
              <button class="btn" type="submit" th:disabled="${b.default}">Đặt làm mặc định</button>
            </form>
            <a th:href="@{'/chat/' + ${b.id}}" class="btn">Chat</a>
          </div>

          <div class="badge" th:if="${b.default}" style="margin-top:8px">Chi nhánh mặc định</div>
        </article>
      </div>

      <!-- Pagination -->
      <div th:if="${page?.totalPages > 1}" class="center" style="gap:8px;margin-top:16px">
        <a class="btn" th:if="${!page.first}"
           th:href="@{/branches(page=${page.number-1}, q=${q}, city=${city}, status=${status})}">← Trước</a>
        <span>Trang <b th:text="${page.number+1}">1</b>/<b th:text="${page.totalPages}">1</b></span>
        <a class="btn" th:if="${!page.last}"
           th:href="@{/branches(page=${page.number+1}, q=${q}, city=${city}, status=${status})}">Sau →</a>
      </div>
    </div>
  </section>

</div>
</html>
