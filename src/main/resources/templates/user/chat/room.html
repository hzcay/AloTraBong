<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi"
      th:replace="~{fragments/layout :: layout(~{::content}, 'Chat với chi nhánh')}">
<div th:fragment="content">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

  <section class="section">
    <div class="container" style="max-width:960px">
      <header class="section-head">
        <h2 class="section-title m-0">Chat với <span th:text="${branchName}">Chi nhánh</span></h2>
        <a th:href="@{/orders}" class="btn">← Đơn hàng</a>
      </header>

      <div class="card" style="height:520px;display:grid;grid-template-rows:auto 1fr auto">
        <!-- Header chat -->
        <div class="center-between pad" style="padding:12px 14px;border-bottom:1px solid var(--line)">
          <div class="center" style="gap:10px;justify-content:flex-start">
            <div class="avatar" th:text="${#strings.substring(branchName?:'B',0,1)}">B</div>
            <div>
              <b th:text="${branchName}">Chi nhánh ABC</b>
              <div class="text-muted" th:text="${branchStatus ?: 'Online'}">Online</div>
            </div>
          </div>
          <a th:href="@{'/chat/' + ${branchId} + '/close'}" class="btn">Kết thúc</a>
        </div>

        <!-- Messages -->
        <div id="chat-scroll" style="padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:#fff">
          <!-- Messages will be loaded dynamically via JavaScript -->
        </div>

        <!-- Composer -->
        <form id="chat-form" style="display:flex;gap:8px;padding:12px;border-top:1px solid var(--line)">
          <input class="input" id="chat-input" placeholder="Nhập tin nhắn…" autocomplete="off" required>
          <button class="btn btn-primary" type="submit">Gửi</button>
          <a th:href="@{'/orders/' + ${orderCode}}" class="btn">Tới đơn #<span th:text="${orderCode}">ALB123</span></a>
        </form>
      </div>
    </div>
  </section>

  <!-- Scripts moved inside fragment to ensure execution with layout -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <script th:inline="javascript">
  (function(){
    let branchId = /*[[${branchId}]]*/ '';
    let currentUserId = /*[[${currentUserId}]]*/ '';
    if(!branchId){
      try{
        const qs = new URLSearchParams(window.location.search);
        branchId = qs.get('branchId') || branchId;
      }catch(e){}
    }
    if(!branchId){
      const parts = window.location.pathname.split('/').filter(Boolean);
      branchId = parts[parts.length-1] || '';
    }
    console.log('branchId:', branchId);
    console.log('currentUserId:', currentUserId);
    window.currentUserId = currentUserId;
    const chatScroll = document.getElementById('chat-scroll');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('chat-input');
    let stompClient = null;
    let convoId = null;

    function scrollBottom(){ if(chatScroll){ chatScroll.scrollTop = chatScroll.scrollHeight; } }
    function appendMessage(senderName, content, mine){
      const wrap = document.createElement('div');
      wrap.style.display='flex';
      wrap.style.justifyContent = mine ? 'flex-end' : 'flex-start';
      const card = document.createElement('div');
      card.className = 'card pad';
      card.style.maxWidth='70%';
      if(mine){ card.style.background='#fff8f1'; card.style.borderColor='#fed7aa'; }
      const text = document.createElement('div');
      text.textContent = content;
      card.appendChild(text);
      wrap.appendChild(card);
      chatScroll.appendChild(wrap);
      scrollBottom();
    }

    function connect(){
      if(stompClient && stompClient.connected) return;
      const socket = new SockJS('/ws');
      stompClient = Stomp.over(socket);
      stompClient.debug = (s)=>console.log('[STOMP]', s);
      stompClient.connect({}, function(){
        console.log('STOMP connected');
      }, (e)=>console.error('CONNECT error', e));
    }
    
    function subscribe(){
      if(!stompClient || !stompClient.connected || !convoId) return;
      if(!window.subscription) {
        window.subscription = stompClient.subscribe('/topic/conversations.'+convoId, function(frame){
          const msg = JSON.parse(frame.body);
          console.log('Received message:', msg);
          // Chỉ hiển thị tin nhắn từ đối phương, không hiển thị tin nhắn của mình
          if(msg.senderUserId && msg.senderUserId !== window.currentUserId) {
            appendMessage(msg.senderName||'Chi nhánh', msg.content||'', false);
          }
        }, (e)=>console.error('SUB error', e));
        console.log('Subscribed to /topic/conversations.'+convoId);
      }
    }

    // CSRF helpers (avoid optional chaining for compatibility)
    var _csrfMeta = document.querySelector('meta[name="_csrf"]');
    var _csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
    const CSRF_TOKEN = _csrfMeta ? _csrfMeta.getAttribute('content') : null;
    const CSRF_HEADER = _csrfHeaderMeta ? _csrfHeaderMeta.getAttribute('content') : null;

    // Create or get conversation for this branch
    fetch('/api/chat/conversations', {
        method:'POST',
        credentials:'same-origin',
        headers:Object.assign({'Content-Type':'application/json'}, CSRF_TOKEN?{[CSRF_HEADER]:CSRF_TOKEN}:{}),
        body: JSON.stringify({ branchId })
      })
      .then(r=>{ if(!r.ok) throw new Error('Create convo failed '+r.status); return r.json(); })
      .then(d=>{
        convoId = d.convoId; 
        console.log('Convo created', convoId);
        connect();
        // Subscribe after a small delay to ensure STOMP is connected
        setTimeout(subscribe, 500);
        // Load history
        return fetch(`/api/chat/conversations/${convoId}/messages?page=0&size=30`, { credentials:'same-origin' });
      })
      .then(r=> r.ok ? r.json() : Promise.resolve(null))
      .then(p=>{
        if(p && p.content){ p.content.reverse().forEach(function(m){
          var senderName = (m.senderName) ? m.senderName : 'Chi nhánh';
          // Phân biệt tin nhắn của mình và đối phương
          var isMine = m.senderUserId && m.senderUserId === window.currentUserId;
          appendMessage(senderName, m.content||'', isMine);
        }); }
      })
      .catch(e=>{ console.error(e); });

    form.addEventListener('submit', function(e){
      e.preventDefault();
      const text = (input.value||'').trim();
      if(!text || !convoId) return;
      fetch('/api/chat/conversations/'+convoId+'/messages', { method:'POST', credentials:'same-origin', headers:Object.assign({'Content-Type':'application/json'}, CSRF_TOKEN?{[CSRF_HEADER]:CSRF_TOKEN}:{}) , body: JSON.stringify({ content: text })})
        .then(()=>{
          appendMessage('Tôi', text, true);
          input.value='';
        })
        .catch(e=>console.error(e));
    });

    scrollBottom();
  })();
</script>

</div>
</html>
