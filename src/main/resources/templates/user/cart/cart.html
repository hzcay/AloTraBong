<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi"
      th:replace="~{fragments/layout :: layout(~{::content}, 'Giỏ hàng')}">
<div th:fragment="content">

  <section class="section">
    <div class="container grid" style="grid-template-columns:1fr .55fr;align-items:start">

      <!-- CART TABLE -->
      <section>
        <header class="section-head">
          <h2 class="section-title m-0">Giỏ hàng của bạn</h2>
          <a th:href="@{/menu}" class="btn">← Tiếp tục mua</a>
        </header>

        <!-- Empty state -->
        <div th:if="${#lists.isEmpty(items)}" class="card pad text-muted">
          Giỏ hàng đang trống. Vào <a th:href="@{/menu}">Menu</a> để thêm món nha!
        </div>

        <!-- Items table -->
        <div th:if="${!#lists.isEmpty(items)}" class="card" style="overflow:hidden">
          <table class="table">
            <thead>
              <tr>
                <th>Sản phẩm</th>
                <th style="text-align:right">Đơn giá</th>
                <th style="text-align:right">Số lượng</th>
                <th style="text-align:right">Tạm tính</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="it : ${items}">
                <td>
                  <div class="center" style="gap:12px;justify-content:flex-start">
                    <a th:href="@{'/p/' + ${it.slug}}" class="card" style="width:72px;height:72px;overflow:hidden">
                      <img th:src="${it.thumbnailUrl}" alt="" style="width:100%;height:100%;object-fit:cover">
                    </a>
                    <div>
                      <a th:href="@{'/p/' + ${it.slug}}" class="bold" th:text="${it.name}">Tên món</a>
                      <div class="text-muted" th:text="${it.branchName}">Chi nhánh A</div>
                    </div>
                  </div>
                </td>

                <td style="text-align:right">
                  <b th:text="${#numbers.formatInteger(it.unitPrice)} + 'đ'">49.000đ</b>
                </td>

                <td style="text-align:right">
                  <form th:action="@{/cart/update}" method="post" class="center" style="gap:8px;justify-content:flex-end">
                    <input type="hidden" name="itemId" th:value="${it.itemId}">
                    <input class="input" type="number" name="qty" min="1" th:value="${it.qty}" style="max-width:90px;text-align:right">
                    <button class="btn" type="submit" title="Cập nhật">Cập nhật</button>
                  </form>
                </td>

                <td style="text-align:right">
                  <b th:text="${#numbers.formatInteger(it.subtotal)} + 'đ'">98.000đ</b>
                </td>

                <td style="text-align:right">
                  <form th:action="@{/cart/remove}" method="post">
                    <input type="hidden" name="itemId" th:value="${it.itemId}">
                    <button class="btn" type="submit" title="Xóa">✕</button>
                  </form>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Coupon (visible when items exist) -->
        <div th:if="${!#lists.isEmpty(items)}" class="card pad" style="margin-top:12px">
          <form th:action="@{/cart/apply-coupon}" method="post" class="center" style="gap:10px;justify-content:flex-start;flex-wrap:wrap">
            <label class="bold">Mã giảm giá</label>
            <input class="input" name="code" th:value="${appliedCoupon?.code}" placeholder="Nhập mã…"
                   style="max-width:240px;border-style:dashed">
            <button class="btn" type="submit">Áp dụng</button>

            <div th:if="${appliedCoupon != null}" class="badge">
              Đã áp dụng: <b th:text="${appliedCoupon.code}">ALO20</b>
              <form th:action="@{/cart/remove-coupon}" method="post" style="margin-left:6px">
                <button class="btn" type="submit" title="Bỏ mã">Bỏ</button>
              </form>
            </div>

            <div th:if="${couponError != null}" class="text-muted" style="color:var(--danger)">
              <b th:text="${couponError}">Mã không hợp lệ</b>
            </div>
          </form>
        </div>
      </section>

      <!-- SUMMARY -->
      <aside>
        <div class="card pad">
          <h3 class="m-0 mb-2 bold text-upper">Tóm tắt đơn</h3>

          <div class="center-between mb-1">
            <span>Tạm tính</span>
            <b th:text="${#numbers.formatInteger(summary?.subtotal)} + 'đ'">0đ</b>
          </div>

          <div class="center-between mb-1" th:if="${summary?.discount > 0}">
            <span>Giảm giá</span>
            <b th:text="'- ' + ${#numbers.formatInteger(summary.discount)} + 'đ'">-0đ</b>
          </div>

          <div class="center-between mb-1">
            <span>Phí giao</span>
            <b th:text="${#numbers.formatInteger(summary?.shippingFee)} + 'đ'">0đ</b>
          </div>

          <div class="center-between" style="margin:10px 0;border-top:1px solid var(--line);padding-top:10px">
            <span class="bold">Tổng thanh toán</span>
            <b style="font-size:20px" th:text="${#numbers.formatInteger(summary?.grandTotal)} + 'đ'">0đ</b>
          </div>

          <div class="grid" style="gap:10px;margin-top:10px">
            <a th:href="@{/menu}" class="btn">Tiếp tục mua</a>
            <a th:href="@{/checkout}" class="btn btn-primary" th:classappend="${#lists.isEmpty(items)} ? ' disabled'">
              Thanh toán →
            </a>
          </div>

          <!-- note nhỏ -->
          <p class="text-muted mb-0" style="margin-top:10px">
            * Phí giao có thể thay đổi theo địa chỉ & chi nhánh.
          </p>
        </div>
      </aside>

    </div>
  </section>

</div>
</html>
