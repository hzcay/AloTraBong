<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  lang="vi"
  th:replace="~{fragments/layout :: layout(~{::content}, 'Thanh toán')}"
>
  <div th:fragment="content">
    <!-- ===== Style nhỏ cho pay-tile & state ===== -->
    <style>
      .pay-method {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
      }
      .pay-tile {
        user-select: none;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 12px 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: 120ms ease;
        background: var(--surface);
        cursor: pointer;
      }
      .pay-tile:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,.06); }
      .pay-tile.is-selected {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px color-mix(in oklab, var(--primary) 22%, transparent);
      }
    </style>

    <!-- BREADCRUMB -->
    <section class="section" aria-label="Đường dẫn">
      <div class="container center-between" style="gap: 12px">
        <nav class="text-muted center" style="gap: 8px">
          <a th:href="@{/}" class="nav center" style="gap: 6px">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M10.5 2.1a2 2 0 0 1 3 0l7.5 7.8a1 1 0 0 1-1.4 1.4L20 10.9V20a2 2 0 0 1-2 2h-4v-6H10v6H6a2 2 0 0 1-2-2v-9.1l-.6.4a1 1 0 1 1-1.2-1.6l8.3-7.6Z"/>
            </svg>
            Trang chủ
          </a>
          <span aria-hidden="true">›</span>
          <a th:href="@{/user/cart}" class="nav">Giỏ hàng</a>
          <span aria-hidden="true">›</span>
          <span class="bold" style="color: var(--text)">Thanh toán</span>
        </nav>

        <a th:href="@{/user/cart}" class="btn center" style="gap: 6px">
          <span aria-hidden="true">←</span> Quay lại giỏ
        </a>
      </div>
    </section>

    <!-- CHECKOUT -->
    <section class="section">
      <div class="container grid" style="grid-template-columns: 1fr 0.55fr; align-items: start; gap: 16px">
        <!-- LEFT: Address + Payment -->
        <section class="grid" style="gap: 14px">
          <!-- 1) ĐỊA CHỈ GIAO HÀNG -->
          <div class="card pad">
            <div class="center-between mb-2">
              <h3 class="m-0 bold text-upper">Địa chỉ giao hàng</h3>
              <a th:href="@{/user/address/manage}" class="btn">Quản lý địa chỉ</a>
            </div>

            <form th:action="@{/user/checkout/address}" method="post" class="grid" style="gap: 10px">
              <!-- CSRF -->
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <!-- payload -->
              <input type="hidden" name="branchId" th:value="${branchId}" />

              <label class="center-between card pad" th:each="ad : ${addresses}">
                <div class="center" style="gap: 10px; justify-content: flex-start">
                  <input type="radio" name="addressId" th:value="${ad.id}" th:checked="${ad.default}" />
                  <div>
                    <b th:text="${ad.fullName}">Nguyễn Văn A</b>
                    <div class="text-muted" th:text="${ad.phone}">0900000000</div>
                    <div th:text="${ad.line + ', ' + ad.ward + ', ' + ad.district + ', ' + ad.city}">
                      Số 1, P.X, Q.Y, TP.Z
                    </div>
                  </div>
                </div>
                <span class="badge" th:if="${ad.default}">Mặc định</span>
              </label>

              <div th:if="${#lists.isEmpty(addresses)}" class="text-muted">
                Chưa có địa chỉ. <a th:href="@{/user/address/manage}">Thêm ngay →</a>
              </div>

              <div class="center" style="justify-content: flex-start; gap: 8px">
                <button class="btn btn-primary" type="submit">Chọn địa chỉ này</button>
                <a th:href="@{/user/address/manage}" class="btn">Thêm địa chỉ mới</a>
              </div>
            </form>
          </div>

          <!-- 2) PHƯƠNG THỨC + CONFIRM: GỘP CHUNG 1 FORM -->
          <div class="card pad">
            <h3 class="m-0 mb-2 bold text-upper">Phương thức thanh toán</h3>

            <!-- MỘT FORM DUY NHẤT -->
            <form id="checkout-form" class="grid" style="gap: 10px" method="post">
              <!-- CSRF (dùng chung cho cả 2 nút/2 action) -->
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

              <!-- branch/address/note để submit cả 2 luồng -->
              <input type="hidden" name="branchId" th:value="${branchId}" />
              <input id="chosen-address" type="hidden" name="addressId" th:value="${selectedAddressId}" />
              <input id="chosen-note" type="hidden" name="note" th:value="${note}" />

              <div class="pay-method">
                <label class="pay-tile" data-code="COD">
                  <input type="radio" name="payment" value="COD" hidden
                         th:checked="${selectedPayment == null || selectedPayment == 'COD'}" />
                  <span>COD</span>
                </label>

                <label class="pay-tile" data-code="VNPAY">
                  <input type="radio" name="payment" value="VNPAY" hidden
                         th:checked="${selectedPayment == 'VNPAY'}" />
                  <span>VNPAY</span>
                </label>

                <label class="pay-tile" data-code="MOMO">
                  <input type="radio" name="payment" value="MOMO" hidden
                         th:checked="${selectedPayment == 'MOMO'}" />
                  <span>MOMO</span>
                </label>
              </div>

              <label class="grid" style="margin-top: 12px">
                <span class="text-muted">Ghi chú đơn hàng (tuỳ chọn)</span>
                <textarea class="textarea" id="note-area" rows="3" th:text="${note}"></textarea>
              </label>

              <!-- 2 nút, cùng 1 form, khác action -->
              <div class="center" style="justify-content: flex-start; gap: 8px; margin-top: 10px">
                <!-- Lưu lựa chọn payment -->
                <button class="btn" type="submit"
                        formaction="/user/checkout/payment" formmethod="post">
                  Chọn phương thức
                </button>

                <!-- Xác nhận đặt hàng -->
                <button id="confirm-btn" class="btn btn-primary" type="submit"
                        formaction="/user/checkout/confirm" formmethod="post"
                        th:disabled="${#lists.isEmpty(items)}">
                  Xác nhận đặt hàng →
                </button>
              </div>

              <div th:if="${paymentError != null}" class="text-muted" style="color: var(--danger); margin-top: 8px">
                <b th:text="${paymentError}">Vui lòng chọn phương thức thanh toán.</b>
              </div>
            </form>
          </div>

          <!-- 3) MÃ GIẢM GIÁ -->
          <div class="card pad">
            <h3 class="m-0 mb-2 bold text-upper">Mã giảm giá</h3>
            <form th:action="@{/user/checkout/apply-coupon}" method="post" class="center"
                  style="gap: 10px; justify-content: flex-start; flex-wrap: wrap">
              <!-- CSRF -->
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <!-- payload -->
              <input type="hidden" name="branchId" th:value="${branchId}" />
              <input class="input" name="code"
                     th:value="${appliedCoupon != null ? appliedCoupon.code : ''}"
                     placeholder="Nhập mã…" style="max-width: 260px; border-style: dashed" />
              <button class="btn" type="submit">Áp dụng</button>

              <div th:if="${appliedCoupon != null}" class="badge">
                <span th:text="${'Đã áp dụng: ' + appliedCoupon.code}">ALO20</span>
                <a th:href="@{/user/coupon/list}" class="nav">Xem thêm mã</a>
              </div>

              <div th:if="${couponError != null}" class="text-muted" style="color: var(--danger)">
                <b th:text="${couponError}">Mã không hợp lệ</b>
              </div>
            </form>
          </div>
        </section>

        <!-- RIGHT: Order summary -->
        <aside class="card pad">
          <h3 class="m-0 mb-2 bold text-upper">Tóm tắt đơn</h3>

          <div class="grid mb-2" style="gap: 10px">
            <div class="center-between" th:each="it : ${items}">
              <div class="center" style="gap: 8px; justify-content: flex-start">
                <div class="card" style="width: 48px; height: 48px; overflow: hidden">
                  <img th:src="${it.thumbnailUrl}" alt=""
                       style="width: 100%; height: 100%; object-fit: cover"
                       onerror="this.onerror=null;this.src='/img/placeholder.jpg'" />
                </div>
                <div>
                  <b th:text="${it.name}">Tên món</b>
                  <div class="text-muted">
                    <span th:text="${it.qty}">1</span> x
                    <span th:text="${#numbers.formatDecimal(it.unitPrice != null ? it.unitPrice : T(java.math.BigDecimal).ZERO, 1, 0) + 'đ'}">0đ</span>
                  </div>
                </div>
              </div>
              <b th:text="${#numbers.formatDecimal(it.subtotal != null ? it.subtotal : T(java.math.BigDecimal).ZERO, 1, 0) + 'đ'}">0đ</b>
            </div>

            <div th:if="${#lists.isEmpty(items)}" class="text-muted">
              Chưa có món nào. <a th:href="@{/user/product/list}">Thêm món →</a>
            </div>
          </div>

          <div class="center-between mb-1">
            <span>Tạm tính</span>
            <b th:text="${#numbers.formatDecimal(summary != null && summary.subtotal != null ? summary.subtotal : T(java.math.BigDecimal).ZERO, 1, 0) + 'đ'}">0đ</b>
          </div>

          <div class="center-between mb-1"
               th:if="${summary != null && summary.discount != null && summary.discount.compareTo(T(java.math.BigDecimal).ZERO) > 0}">
            <span>Giảm giá</span>
            <b th:text="${'- ' + #numbers.formatDecimal(summary.discount, 1, 0) + 'đ'}">-0đ</b>
          </div>

          <div class="center-between mb-1">
            <span>Phí giao</span>
            <b th:text="${#numbers.formatDecimal(summary != null && summary.shippingFee != null ? summary.shippingFee : T(java.math.BigDecimal).ZERO, 1, 0) + 'đ'}">0đ</b>
          </div>

          <div class="center-between" style="margin: 10px 0; border-top: 1px solid var(--line); padding-top: 10px;">
            <span class="bold">Tổng thanh toán</span>
            <b style="font-size: 20px"
               th:text="${#numbers.formatDecimal(summary != null && summary.grandTotal != null ? summary.grandTotal : T(java.math.BigDecimal).ZERO, 1, 0) + 'đ'}">0đ</b>
          </div>
        </aside>
      </div>
    </section>
  </div>

  <!-- JS: chọn tile + đồng bộ address/note + enable/disable + log -->
  <script>
  (function () {
    const tiles = [...document.querySelectorAll('.pay-tile')];
    const radios = [...document.querySelectorAll('input[name="payment"]')];
    const form   = document.getElementById('checkout-form');
    const noteTA = document.getElementById('note-area');
    const noteH  = document.getElementById('chosen-note');
    const addrH  = document.getElementById('chosen-address');
    const confirmBtn = document.getElementById('confirm-btn');

    function dump(tag) {
      const r = document.querySelector('input[name="payment"]:checked');
      console.log(`[${tag}] payment=`, r?.value, 'addressId=', addrH?.value, 'note=', noteH?.value);
    }

    function syncTile() {
      tiles.forEach(t => {
        const inp = t.querySelector('input[type="radio"]');
        t.classList.toggle('is-selected', !!(inp && inp.checked));
      });
    }

    // Tile click => check + change
    tiles.forEach(t => {
      t.addEventListener('click', () => {
        const inp = t.querySelector('input[type="radio"]');
        if (!inp) return;
        if (!inp.checked) {
          inp.checked = true;
          inp.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
    });

    radios.forEach(r => {
      r.addEventListener('change', () => { syncTile(); toggleConfirm(); dump('radio-change'); });
    });

    // Sync note -> hidden (để submit cả 2 nút cùng có note)
    if (noteTA && noteH) {
      const push = () => noteH.value = noteTA.value || '';
      noteTA.addEventListener('input', push, { passive: true });
      push();
    }

    // Sync address từ form trên nếu user đổi (nằm khác form)
    const addressRadios = [...document.querySelectorAll('input[name="addressId"]')];
    addressRadios.forEach(r => {
      r.addEventListener('change', () => { addrH.value = r.value; toggleConfirm(); dump('address-change'); });
      if (r.checked) addrH.value = r.value;
    });

    function toggleConfirm() {
      const hasPay = !!document.querySelector('input[name="payment"]:checked');
      const hasAddr = !!addrH?.value;
      if (confirmBtn) confirmBtn.disabled = !(hasPay && hasAddr);
    }

    // Debug payload trước submit (cả 2 nút)
    if (form) {
      form.addEventListener('submit', (e) => {
        dump('before-submit');
        try {
          const fd = new FormData(form);
          console.log('--- FORM PAYLOAD ---');
          for (const [k,v] of fd.entries()) console.log(k, '=>', v);
          console.log('---------------------');
        } catch {}
      }, { capture: true });
    }

    // init
    syncTile();
    toggleConfirm();
    dump('init');
  })();
  </script>
</html>