<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  lang="vi"
  th:replace="~{fragments/layout :: layout(~{::content}, 'Thanh toán')}"
>
  <div th:fragment="content">
    <style>
      .pay-method {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
      }
      .pay-tile {
        user-select: none;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 12px 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: 120ms ease;
        background: var(--surface);
        cursor: pointer;
        font-weight: 500;
      }
      .pay-tile:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 14px rgba(0,0,0,.06);
      }
      .pay-tile.is-selected {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px color-mix(in oklab, var(--primary) 22%, transparent);
      }
    </style>

    <!-- BREADCRUMB -->
    <section class="section" aria-label="Đường dẫn">
      <div class="container center-between" style="gap: 12px">
        <nav class="text-muted center" style="gap: 8px">
          <a th:href="@{/}" class="nav center" style="gap: 6px">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M10.5 2.1a2 2 0 0 1 3 0l7.5 7.8a1 1 0 0 1-1.4 1.4L20 10.9V20a2 2 0 0 1-2 2h-4v-6H10v6H6a2 2 0 0 1-2-2v-9.1l-.6.4a1 1 0 1 1-1.2-1.6l8.3-7.6Z"/>
            </svg>
            Trang chủ
          </a>
          <span aria-hidden="true">›</span>
          <a th:href="@{/user/cart}" class="nav">Giỏ hàng</a>
          <span aria-hidden="true">›</span>
          <span class="bold" style="color: var(--text)">Thanh toán</span>
        </nav>

        <a th:href="@{/user/cart}" class="btn center" style="gap: 6px">
          <span aria-hidden="true">←</span> Quay lại giỏ
        </a>
      </div>
    </section>

    <!-- CHECKOUT -->
    <section class="section">
      <div class="container grid" style="grid-template-columns: 1fr 0.55fr; align-items: start; gap: 16px">
        <!-- LEFT: Address + Payment -->
        <section class="grid" style="gap: 14px">

          <!-- 1) ĐỊA CHỈ GIAO HÀNG -->
          <div class="card pad">
            <div class="center-between mb-2">
              <h3 class="m-0 bold text-upper">Địa chỉ giao hàng</h3>
              <a th:href="@{/user/address/manage}" class="btn">Quản lý địa chỉ</a>
            </div>

            <form th:action="@{/user/checkout/address}" method="post" class="grid" style="gap: 10px">
              <!-- CSRF -->
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <!-- payload -->
              <input type="hidden" name="branchId" th:value="${branchId}" />

              <label class="center-between card pad" th:each="ad : ${addresses}">
                <div class="center" style="gap: 10px; justify-content: flex-start">
                  <input type="radio" name="addressId" th:value="${ad.id}" th:checked="${ad.default}" />
                  <div>
                    <b th:text="${ad.fullName}">Nguyễn Văn A</b>
                    <div class="text-muted" th:text="${ad.phone}">0900000000</div>
                    <div th:text="${ad.line + ', ' + ad.ward + ', ' + ad.district + ', ' + ad.city}">
                      Số 1, P.X, Q.Y, TP.Z
                    </div>
                  </div>
                </div>
                <span class="badge" th:if="${ad.default}">Mặc định</span>
              </label>

              <div th:if="${#lists.isEmpty(addresses)}" class="text-muted">
                Chưa có địa chỉ. <a th:href="@{/user/address/manage}">Thêm ngay →</a>
              </div>

              <div class="center" style="justify-content: flex-start; gap: 8px">
                <button class="btn btn-primary" type="submit">Chọn địa chỉ này</button>
                <a th:href="@{/user/address/manage}" class="btn">Thêm địa chỉ mới</a>
              </div>
            </form>
          </div>

          <!-- 2) PHƯƠNG THỨC THANH TOÁN -->
          <div class="card pad">
            <div class="center-between mb-2" style="align-items:flex-start">
              <div>
                <h3 class="m-0 bold text-upper">Phương thức thanh toán</h3>

                <!-- dòng hiển thị phương thức hiện tại -->
                <div class="text-muted" style="font-size: 0.9rem;">
                  <span id="current-method-label"
                        th:text="${selectedPayment != null ? selectedPayment : 'Chưa chọn'}">
                    Chưa chọn
                  </span>
                </div>
              </div>

              <!-- nút để bật selector -->
              <button id="toggle-payment-btn" class="btn" type="button" style="white-space:nowrap">
                Chọn phương thức
              </button>
            </div>

            <!-- FORM CHUNG ĐỂ SUBMIT KHI ĐẶT HÀNG -->
            <form id="checkout-form" class="grid" style="gap: 10px" method="post">
              <!-- CSRF -->
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

              <!-- payload chung -->
              <input type="hidden" name="branchId" th:value="${branchId}" />
              <input id="chosen-address" type="hidden" name="addressId" th:value="${selectedAddressId}" />
              <input id="chosen-note"    type="hidden" name="note"       th:value="${note}" />
              <input id="chosen-payment" type="hidden" name="payment"
                     th:value="${selectedPayment != null ? selectedPayment : ''}" />

              <!-- vùng để JS render các lựa chọn COD / VNPAY / MOMO -->
              <div id="payment-list-wrapper"></div>

              <!-- GHI CHÚ -->
              <label class="grid">
                <span class="text-muted">Ghi chú đơn hàng (tuỳ chọn)</span>
                <textarea class="textarea" id="note-area" rows="3" th:text="${note}"></textarea>
              </label>

              <div th:if="${paymentError != null}" class="text-muted" style="color: var(--danger); margin-top: 8px">
                <b th:text="${paymentError}">Vui lòng chọn phương thức thanh toán.</b>
              </div>
            </form>
          </div>

          <!-- 3) MÃ GIẢM GIÁ -->
          <div class="card pad">
            <h3 class="m-0 mb-2 bold text-upper">Mã giảm giá</h3>
            <form th:action="@{/user/checkout/apply-coupon}" method="post" class="center"
                  style="gap: 10px; justify-content: flex-start; flex-wrap: wrap">
              <!-- CSRF -->
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <!-- payload -->
              <input type="hidden" name="branchId" th:value="${branchId}" />

              <input class="input" name="code"
                     th:value="${appliedCoupon != null ? appliedCoupon.code : ''}"
                     placeholder="Nhập mã…"
                     style="max-width: 260px; border-style: dashed" />

              <button class="btn" type="submit">Áp dụng</button>

              <div th:if="${appliedCoupon != null}" class="badge">
                <span th:text="${'Đã áp dụng: ' + appliedCoupon.code}">ALO20</span>
                <a th:href="@{/user/coupon/list}" class="nav">Xem thêm mã</a>
              </div>

              <div th:if="${couponError != null}" class="text-muted" style="color: var(--danger)">
                <b th:text="${couponError}">Mã không hợp lệ</b>
              </div>
            </form>
          </div>
        </section>

        <!-- RIGHT: Order summary + NÚT ĐẶT HÀNG -->
        <aside class="card pad">
          <h3 class="m-0 mb-2 bold text-upper">Tóm tắt đơn</h3>

          <div class="grid mb-2" style="gap: 10px">
            <div class="center-between" th:each="it : ${items}">
              <div class="center" style="gap: 8px; justify-content: flex-start">
                <div class="card" style="width: 48px; height: 48px; overflow: hidden">
                  <img th:src="${it.thumbnailUrl}" alt=""
                       style="width: 100%; height: 100%; object-fit: cover"
                       onerror="this.onerror=null;this.src='/img/placeholder.jpg'" />
                </div>
                <div>
                  <b th:text="${it.name}">Tên món</b>
                  <div class="text-muted">
                    <span th:text="${it.qty}">1</span> x
                    <span th:text="${#numbers.formatDecimal(it.unitPrice != null ? it.unitPrice : T(java.math.BigDecimal).ZERO, 1, 0) + 'đ'}">0đ</span>
                  </div>
                </div>
              </div>
              <b th:text="${#numbers.formatDecimal(it.subtotal != null ? it.subtotal : T(java.math.BigDecimal).ZERO, 1, 0) + 'đ'}">0đ</b>
            </div>

            <div th:if="${#lists.isEmpty(items)}" class="text-muted">
              Chưa có món nào. <a th:href="@{/user/product/list}">Thêm món →</a>
            </div>
          </div>

          <div class="center-between mb-1">
            <span>Tạm tính</span>
            <b th:text="${#numbers.formatDecimal(summary != null && summary.subtotal != null ? summary.subtotal : T(java.math.BigDecimal).ZERO, 1, 0) + 'đ'}">0đ</b>
          </div>

          <div class="center-between mb-1"
               th:if="${summary != null && summary.discount != null && summary.discount.compareTo(T(java.math.BigDecimal).ZERO) > 0}">
            <span>Giảm giá</span>
            <b th:text="${'- ' + #numbers.formatDecimal(summary.discount, 1, 0) + 'đ'}">-0đ</b>
          </div>

          <div class="center-between mb-1">
            <span>Phí giao</span>
            <b th:text="${#numbers.formatDecimal(summary != null && summary.shippingFee != null ? summary.shippingFee : T(java.math.BigDecimal).ZERO, 1, 0) + 'đ'}">0đ</b>
          </div>

          <div class="center-between" style="margin: 10px 0; border-top: 1px solid var(--line); padding-top: 10px;">
            <span class="bold">Tổng thanh toán</span>
            <b style="font-size: 20px"
               th:text="${#numbers.formatDecimal(summary != null && summary.grandTotal != null ? summary.grandTotal : T(java.math.BigDecimal).ZERO, 1, 0) + 'đ'}">0đ</b>
          </div>

          <!-- NÚT XÁC NHẬN ĐẶT HÀNG -->
          <button
            id="confirm-btn"
            class="btn btn-primary"
            type="submit"
            form="checkout-form"
            formaction="/user/checkout/confirm"
            formmethod="post"
            th:disabled="${#lists.isEmpty(items)}"
            style="width:100%; margin-top:12px"
          >
            Xác nhận đặt hàng →
          </button>
        </aside>
      </div>
    </section>

    <!-- JS BÂY GIỜ NẰM TRONG FRAGMENT (QUAN TRỌNG) -->
    <script>
      window.addEventListener('DOMContentLoaded', function() {
        const form            = document.getElementById('checkout-form');
        const noteTA          = document.getElementById('note-area');
        const noteH           = document.getElementById('chosen-note');
        const addrH           = document.getElementById('chosen-address');
        const payHidden       = document.getElementById('chosen-payment');

        const confirmBtn      = document.getElementById('confirm-btn');

        const toggleBtn       = document.getElementById('toggle-payment-btn');
        const payWrapper      = document.getElementById('payment-list-wrapper');
        const curLabel        = document.getElementById('current-method-label');

        function dump(tag) {
          console.log(
            '[' + tag + ']',
            'payment=', payHidden?.value,
            'addressId=', addrH?.value,
            'note=', noteH?.value
          );
        }

        function toggleConfirm() {
          const hasPay  = !!payHidden?.value;
          const hasAddr = !!addrH?.value;
          if (confirmBtn) confirmBtn.disabled = !(hasPay && hasAddr);
        }

        function syncNoteHidden() {
          if (!noteTA || !noteH) return;
          noteH.value = noteTA.value || '';
        }

        function choosePayment(methodCode) {
          if (payHidden) payHidden.value = methodCode || '';
          if (curLabel)  curLabel.textContent = methodCode || 'Chưa chọn';

          if (payWrapper) {
            payWrapper.innerHTML = '';
            payWrapper.dataset.open = '0';
          }

          toggleConfirm();
          dump('choosePayment:' + methodCode);
        }

        function toggleChooser() {
          if (!payWrapper) return;

          // nếu đang mở -> đóng
          if (payWrapper.dataset.open === '1') {
            payWrapper.innerHTML = '';
            payWrapper.dataset.open = '0';
            return;
          }

          // build UI list
          payWrapper.innerHTML = `
            <div class="pay-method" style="margin-bottom:12px">
              <button type="button" class="pay-tile" data-method="COD">COD</button>
              <button type="button" class="pay-tile" data-method="VNPAY">VNPAY</button>
              <button type="button" class="pay-tile" data-method="MOMO">MOMO</button>
            </div>
          `;
          payWrapper.dataset.open = '1';

          const curr = payHidden?.value;
          if (curr) {
            [...payWrapper.querySelectorAll('.pay-tile')].forEach(tile => {
              if (tile.getAttribute('data-method') === curr) {
                tile.classList.add('is-selected');
              }
            });
          }

          // attach click handler cho từng tile sau khi render
          [...payWrapper.querySelectorAll('.pay-tile')].forEach(tile => {
            tile.addEventListener('click', () => {
              const code = tile.getAttribute('data-method');
              choosePayment(code);
            });
          });

          // scroll tới chỗ list
          payWrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // GẮN SỰ KIỆN Ở ĐÂY LUÔN
        if (toggleBtn) {
          toggleBtn.addEventListener('click', toggleChooser);
        }

        // đồng bộ ghi chú -> hidden
        if (noteTA) {
          noteTA.addEventListener('input', () => {
            syncNoteHidden();
            dump('note-change');
          }, { passive: true });
        }
        syncNoteHidden();

        // đồng bộ địa chỉ giao hàng
        const addrRadios = [...document.querySelectorAll('input[name="addressId"]')];
        addrRadios.forEach(r => {
          r.addEventListener('change', () => {
            addrH.value = r.value;
            toggleConfirm();
            dump('address-change');
          });
          if (r.checked) {
            addrH.value = r.value;
          }
        });

        // debug trước submit
        if (form) {
          form.addEventListener('submit', (e) => {
            dump('before-submit');
            try {
              const fd = new FormData(form);
              console.log('--- FORM PAYLOAD ---');
              for (const [k,v] of fd.entries()) console.log(k, '=>', v);
              console.log('---------------------');
            } catch {}
          }, { capture: true });
        }

        // init
        toggleConfirm();
        dump('init');
      });
    </script>
  </div>
</html>
