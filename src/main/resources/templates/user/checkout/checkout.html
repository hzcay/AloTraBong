<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  lang="vi"
  th:replace="~{fragments/layout :: layout(~{::content}, 'Thanh to√°n')}">

  <div th:fragment="content">
    <style>
      .pay-method {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
      }
      .pay-tile {
        user-select: none;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 12px 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: 120ms ease;
        background: var(--surface);
        cursor: pointer;
        font-weight: 500;
      }
      .pay-tile:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 14px rgba(0,0,0,.06);
      }
      .pay-tile.is-selected {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px color-mix(in oklab, var(--primary) 22%, transparent);
      }
      .coupon-item:hover { background: color-mix(in oklab, var(--primary) 4%, transparent); }
    </style>

    <!-- BREADCRUMB -->
    <section class="section" aria-label="ƒê∆∞·ªùng d·∫´n">
      <div class="container center-between" style="gap: 12px">
        <nav class="text-muted center" style="gap: 8px">
          <a th:href="@{/}" class="nav center" style="gap: 6px">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M10.5 2.1a2 2 0 0 1 3 0l7.5 7.8a1 1 0 0 1-1.4 1.4L20 10.9V20a2 2 0 0 1-2 2h-4v-6H10v6H6a2 2 0 0 1-2-2v-9.1l-.6.4a1 1 0 1 1-1.2-1.6l8.3-7.6Z"/>
            </svg>
            Trang ch·ªß
          </a>
          <span aria-hidden="true">‚Ä∫</span>
          <a th:href="@{/user/cart}" class="nav">Gi·ªè h√†ng</a>
          <span aria-hidden="true">‚Ä∫</span>
          <span class="bold" style="color: var(--text)">Thanh to√°n</span>
        </nav>

        <a th:href="@{/user/cart}" class="btn center" style="gap: 6px">
          <span aria-hidden="true">‚Üê</span> Quay l·∫°i gi·ªè
        </a>
      </div>
    </section>

    <!-- CHECKOUT -->
    <section class="section">
      <div class="container grid" style="grid-template-columns: 1fr 0.55fr; align-items: start; gap: 16px">

        <!-- LEFT -->
        <section class="grid" style="gap: 14px">

          <!-- 1) ƒê·ªäA CH·ªà GIAO H√ÄNG -->
          <div class="card pad">
            <div class="center-between mb-2">
              <h3 class="m-0 bold text-upper">ƒê·ªãa ch·ªâ giao h√†ng</h3>
              <a th:href="@{/user/address/manage}" class="btn">Qu·∫£n l√Ω ƒë·ªãa ch·ªâ</a>
            </div>

            <form th:action="@{/user/checkout/address}" method="post" class="grid" style="gap: 10px">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <input type="hidden" name="branchId" th:value="${branchId}" />

              <label class="center-between card pad" th:each="ad : ${addresses}">
                <div class="center" style="gap: 10px; justify-content: flex-start">
                  <input type="radio" name="addressId" th:value="${ad.id}" th:checked="${ad.default}" />
                  <div>
                    <b th:text="${ad.fullName}">Nguy·ªÖn VƒÉn A</b>
                    <div class="text-muted" th:text="${ad.phone}">0900000000</div>
                    <div th:text="${ad.line + ', ' + ad.district + ', ' + ad.city}">S·ªë 1, P.X, Q.Y, TP.Z</div>
                  </div>
                </div>
                <span class="badge" th:if="${ad.default}">M·∫∑c ƒë·ªãnh</span>
              </label>

              <div th:if="${#lists.isEmpty(addresses)}" class="text-muted">
                Ch∆∞a c√≥ ƒë·ªãa ch·ªâ. <a th:href="@{/user/address/manage}">Th√™m ngay ‚Üí</a>
              </div>

              <div class="center" style="justify-content: flex-start; gap: 8px">
                <button class="btn btn-primary" type="submit">Ch·ªçn ƒë·ªãa ch·ªâ n√†y</button>
                <a th:href="@{/user/address/manage}" class="btn">Th√™m ƒë·ªãa ch·ªâ m·ªõi</a>
              </div>
            </form>

            <!-- ‚ö†Ô∏è C·∫¢NH B√ÅO NGO√ÄI KHU V·ª∞C -->
            <div th:if="${branchError != null}" 
                 class="card pad" 
                 style="margin-top:12px;border:1px solid #f5c2c7;background:#f8d7da;color:#842029">
              <b th:text="${branchError}">
                R·∫•t ti·∫øc, khu v·ª±c c·ªßa b·∫°n ch∆∞a ƒë∆∞·ª£c h·ªó tr·ª£ giao h√†ng.
              </b>
            </div>
          </div>

          <!-- üè™ CH·ªåN CHI NH√ÅNH -->
          <div class="card pad">
          <h3 class="m-0 mb-2 bold text-upper">Chi nh√°nh ph·ª•c v·ª•</h3>
          <form th:action="@{/user/checkout}" method="get" class="grid" style="gap: 10px;">
            <select name="branchIdParam"
                    class="input"
                    style="padding:10px;border-radius:8px;border:1px solid var(--line);"
                    onchange="this.form.submit()">
              <option th:each="b : ${branches}"
                      th:value="${b.branchId}"
                      th:selected="${b.branchId == branchId}"
                      th:text="${b.name + ' - ' + b.city}">
                Chi nh√°nh
              </option>
            </select>
            <noscript>
              <button type="submit" class="btn btn-primary">√Åp d·ª•ng</button>
            </noscript>
          </form>
        </div>

          <!-- 2) PH∆Ø∆†NG TH·ª®C THANH TO√ÅN -->
          <div class="card pad">
            <div class="center-between mb-2" style="align-items:flex-start">
              <div>
                <h3 class="m-0 bold text-upper">Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
                <div class="text-muted" style="font-size: 0.9rem;">
                  <span id="current-method-label"
                        th:text="${selectedPayment != null ? selectedPayment : 'Ch∆∞a ch·ªçn'}">Ch∆∞a ch·ªçn</span>
                </div>
              </div>
              <button id="toggle-payment-btn" class="btn" type="button" style="white-space:nowrap">
                Ch·ªçn ph∆∞∆°ng th·ª©c
              </button>
            </div>

            <form id="checkout-form" class="grid" style="gap: 10px" method="post">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <input type="hidden" name="branchId" th:value="${branchId}" />
              <input id="chosen-address" type="hidden" name="addressId" th:value="${selectedAddressId}" />
              <input id="chosen-note" type="hidden" name="note" th:value="${note}" />
              <input id="chosen-payment" type="hidden" name="payment"
                     th:value="${selectedPayment != null ? selectedPayment : ''}" />
              <div id="payment-list-wrapper"></div>

              <label class="grid">
                <span class="text-muted">Ghi ch√∫ ƒë∆°n h√†ng (tu·ª≥ ch·ªçn)</span>
                <textarea class="textarea" id="note-area" rows="3" th:text="${note}"></textarea>
              </label>
            </form>
          </div>

          <!-- 3) M√É GI·∫¢M GI√Å -->
          <div class="card pad">
            <h3 class="m-0 mb-2 bold text-upper">M√£ gi·∫£m gi√°</h3>

            <form th:action="@{/user/checkout/apply-coupon}" method="post"
                  class="center" style="gap:10px; justify-content:flex-start; flex-wrap:wrap; position:relative">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <input type="hidden" name="branchId" th:value="${branchId}" />

              <div class="coupon-input-group" style="display:flex; gap:8px; align-items:center; position:relative; flex-wrap:wrap;">
                <!-- √î nh·∫≠p m√£ -->
                <input id="coupon-code-input"
                      class="input"
                      name="code"
                      th:value="${appliedCoupon != null ? appliedCoupon.code : ''}"
                      placeholder="Nh·∫≠p m√£‚Ä¶"
                      style="max-width:260px; border-style:dashed" />

                <!-- NEW: N√∫t ch·ªçn m√£ (n·∫±m TR∆Ø·ªöC n√∫t √Åp d·ª•ng) -->
                <button id="btn-choose-coupon" type="button" class="btn" style="white-space:nowrap">
                  Ch·ªçn m√£ ‚ñº
                </button>

                <!-- N√∫t √°p d·ª•ng (nh∆∞ c≈©) -->
                <button class="btn" type="submit">√Åp d·ª•ng</button>

                <!-- Dropdown danh s√°ch m√£ ƒë·ªß ƒëi·ªÅu ki·ªán -->
                <div id="coupon-dropdown"
                  class="coupon-dd"
                  style="display:none; position:fixed; z-index:10000;
                          background:var(--surface); border:1px solid var(--line); border-radius:10px;
                          box-shadow:0 10px 30px rgba(0,0,0,.18); padding:8px; max-height:360px; overflow:auto; min-width:320px; will-change: top,left;">
                  <!-- C√≥ m√£ h·ª£p l·ªá -->
                  <div th:if="${eligibleCoupons != null and !#lists.isEmpty(eligibleCoupons)}"
                        class="grid coupon-list" style="gap:8px;">
                    <label th:each="cp : ${eligibleCoupons}"
                          class="coupon-item center-between"
                          style="border:1px solid var(--line); border-radius:10px; padding:10px; gap:10px; cursor:pointer;"
                          th:attr="data-code=${cp.code}">
                      <div>
                        <div class="center" style="gap:8px; justify-content:flex-start;">
                          <b th:text="${cp.code}">SALE10</b>
                          <span class="badge" th:text="${cp.type}">PERCENT</span>
                        </div>
                        <div class="text-muted" style="font-size:.9rem;">
                          <span th:text="${cp.type == 'PERCENT' ? ('Gi·∫£m ' + cp.value + '%') : ('Gi·∫£m ' + #numbers.formatDecimal(cp.value,1,0) + 'ƒë')}">
                            Gi·∫£m ‚Ä¶
                          </span>
                          <span th:if="${cp.minSubtotal != null}">
                            ‚Ä¢ ƒêH t·ªëi thi·ªÉu
                            <b th:text="${#numbers.formatDecimal(cp.minSubtotal,1,0) + 'ƒë'}">0ƒë</b>
                          </span>
                        </div>
                        <div class="text-muted" style="font-size:.85rem;">
                          HSD:
                          <span th:text="${#temporals.format(cp.endsAt, 'dd/MM/yyyy')}">dd/MM/yyyy</span>
                        </div>
                      </div>
                      <button type="button" class="btn" style="white-space:nowrap">D√πng ngay</button>
                    </label>
                  </div>

                  <!-- Kh√¥ng c√≥ m√£ h·ª£p l·ªá -->
                  <div th:if="${eligibleCoupons == null or #lists.isEmpty(eligibleCoupons)}"
                      class="text-muted" style="padding:8px;">
                    Kh√¥ng c√≥ m√£ ph√π h·ª£p v·ªõi ƒë∆°n hi·ªán t·∫°i.
                    <a th:href="@{/user/coupon/list}" class="nav">Xem t·∫•t c·∫£ m√£ ‚Üí</a>
                  </div>
                </div>

                <!-- Tag hi·ªÉn th·ªã m√£ ƒë√£ √°p d·ª•ng (n·∫øu c√≥) -->
                <div th:if="${appliedCoupon != null}" class="badge">
                  <span th:text="${'ƒê√£ √°p d·ª•ng: ' + appliedCoupon.code}">ALO20</span>
                  <a th:href="@{/user/coupon/list}" class="nav">Xem th√™m m√£</a>
                </div>

                <!-- L·ªói m√£ -->
                <div th:if="${couponError != null}" class="text-muted" style="color: var(--danger)">
                  <b th:text="${couponError}">M√£ kh√¥ng h·ª£p l·ªá</b>
                </div>
              </div>
            </form>
          </div>
        </section>

        <!-- RIGHT: Order summary -->
        <aside class="card pad">
          <h3 class="m-0 mb-2 bold text-upper">T√≥m t·∫Øt ƒë∆°n</h3>
          <div class="grid mb-2" style="gap: 10px">
            <div class="center-between" th:each="it : ${items}">
              <div class="center" style="gap: 8px; justify-content: flex-start">
                <div class="card" style="width: 48px; height: 48px; overflow: hidden">
                  <img th:src="${it.thumbnailUrl}" alt=""
                      style="width: 100%; height: 100%; object-fit: cover"
                      onerror="this.onerror=null;this.src='/img/placeholder.jpg'" />
                </div>
                <div>
                  <b th:text="${it.name}">T√™n m√≥n</b>
                  <div class="text-muted">
                    <span th:text="${it.qty}">1</span> x
                    <span th:text="${#numbers.formatDecimal(it.unitPrice,1,0) + 'ƒë'}">0ƒë</span>
                  </div>
                </div>
              </div>
              <b th:text="${#numbers.formatDecimal(it.subtotal,1,0) + 'ƒë'}">0ƒë</b>
            </div>

            <div th:if="${#lists.isEmpty(items)}" class="text-muted">
              Ch∆∞a c√≥ m√≥n n√†o. <a th:href="@{/user/product/list}">Th√™m m√≥n ‚Üí</a>
            </div>
          </div>

          <div class="center-between mb-1">
            <span>T·∫°m t√≠nh</span>
            <b th:text="${summary != null ? #numbers.formatDecimal(summary.subtotal, 1, 0) + 'ƒë' : '0ƒë'}">0ƒë</b>
          </div>

          <div class="center-between mb-1"
              th:if="${summary != null and summary.discount != null and summary.discount > 0}">
            <span>Gi·∫£m gi√°</span>
            <b th:text="${'- ' + #numbers.formatDecimal(summary.discount,1,0) + 'ƒë'}">-0ƒë</b>
          </div>

          <div class="center-between mb-1">
            <span>Ph√≠ giao</span>
            <b th:text="${summary != null ? #numbers.formatDecimal(summary.shippingFee,1,0) + 'ƒë' : '0ƒë'}">0ƒë</b>
          </div>

          <div class="center-between"
              style="margin:10px 0;border-top:1px solid var(--line);padding-top:10px;">
            <span class="bold">T·ªïng thanh to√°n</span>
            <b style="font-size:20px"
              th:text="${summary != null ? #numbers.formatDecimal(summary.grandTotal,1,0) + 'ƒë' : '0ƒë'}">0ƒë</b>
          </div>

          <button id="confirm-btn" class="btn btn-primary"
                  type="submit" form="checkout-form"
                  formaction="/user/checkout/confirm"
                  formmethod="post"
                  th:disabled="${#lists.isEmpty(items)}"
                  style="width:100%;margin-top:12px">
            X√°c nh·∫≠n ƒë·∫∑t h√†ng ‚Üí
          </button>
        </aside>
      </div>
    </section>

    <script>
      /* ===== Coupon chooser: floating portal + auto up/down ===== */
      (() => {
        const btn = document.getElementById('btn-choose-coupon');
        const dd  = document.getElementById('coupon-dropdown');      // container ƒë√£ render s·∫µn trong HTML
        const inp = document.getElementById('coupon-code-input');

        if (!btn || !dd || !inp) return;

        let isOpen = false;
        let onDocClick, onReposition;

        function openDD() {
          // ƒê∆∞a dropdown ra body ƒë·ªÉ tr√°nh overflow/stacking c·ªßa cha
          if (dd.parentNode !== document.body) document.body.appendChild(dd);
          dd.style.display = 'block';
          btn.setAttribute('aria-expanded', 'true');
          btn.textContent = 'Ch·ªçn m√£ ‚ñ≤';
          isOpen = true;
          positionDD();

          onDocClick = (e) => {
            if (e.target === btn || btn.contains(e.target)) return;
            if (dd.contains(e.target)) return;
            closeDD();
          };
          document.addEventListener('click', onDocClick, true);

          onReposition = () => positionDD();
          window.addEventListener('resize', onReposition, true);
          window.addEventListener('scroll', onReposition, true);
        }

        function closeDD() {
          dd.style.display = 'none';
          btn.setAttribute('aria-expanded', 'false');
          btn.textContent = 'Ch·ªçn m√£ ‚ñº';
          isOpen = false;

          if (onDocClick) document.removeEventListener('click', onDocClick, true);
          if (onReposition) {
            window.removeEventListener('resize', onReposition, true);
            window.removeEventListener('scroll', onReposition, true);
          }
        }

        function positionDD() {
          // CƒÉn theo button v√† nh√≥m input
          const r = btn.getBoundingClientRect();
          const group = btn.closest('.coupon-input-group') || btn.parentElement;
          const gr = group ? group.getBoundingClientRect() : r;

          const vw = window.innerWidth, vh = window.innerHeight;
          const spaceDown = vh - r.bottom - 8;
          const spaceUp   = r.top - 8;

          // R·ªông t·ªëi thi·ªÉu: theo chi·ªÅu r·ªông nh√≥m input cho ƒë·∫πp
          const minW = Math.max(Math.min(gr.width, 520), 320);
          dd.style.minWidth = minW + 'px';

          // Reset ƒë·ªÉ ƒëo chi·ªÅu cao th·∫≠t
          dd.style.maxHeight = '360px';
          dd.style.top = '-9999px';
          dd.style.left = '-9999px';

          requestAnimationFrame(() => {
            const desiredH = Math.min(360, dd.offsetHeight || 360);

            let top, maxH;
            if (spaceDown >= 220 || spaceDown >= spaceUp) {   // m·ªü xu·ªëng
              top  = r.bottom + 6;
              maxH = Math.max(160, Math.min(360, spaceDown - 12));
            } else {                                          // m·ªü l√™n
              maxH = Math.max(160, Math.min(desiredH, spaceUp - 12));
              top  = Math.max(8, r.top - maxH - 6);
            }
            dd.style.maxHeight = maxH + 'px';

            // CƒÉn tr√°i theo nh√≥m, tr√°nh tr√†n viewport
            const left = Math.min(vw - minW - 8, Math.max(8, gr.left));
            dd.style.top  = top + 'px';
            dd.style.left = left + 'px';
          });
        }

        // Toggle
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          isOpen ? closeDD() : openDD();
        });

        // Click ch·ªçn m√£ ‚Üí fill input + ƒë√≥ng
        dd.addEventListener('click', (e) => {
          const label = e.target.closest('.coupon-item');
          if (!label) return;
          const code = label.getAttribute('data-code');
          if (code) {
            inp.value = code;
            closeDD();
            inp.focus();
          }
        });

        // ESC ƒë·ªÉ ƒë√≥ng
        document.addEventListener('keydown', (e) => {
          if (isOpen && e.key === 'Escape') closeDD();
        });
      })();

      /* ===== Payment chooser (gi·ªØ logic c≈©) ===== */
      window.addEventListener('DOMContentLoaded', function() {
        const noteTA     = document.getElementById('note-area');
        const noteH      = document.getElementById('chosen-note');
        const addrH      = document.getElementById('chosen-address');
        const payHidden  = document.getElementById('chosen-payment');
        const confirmBtn = document.getElementById('confirm-btn');
        const toggleBtn  = document.getElementById('toggle-payment-btn');
        const payWrapper = document.getElementById('payment-list-wrapper');
        const curLabel   = document.getElementById('current-method-label');

        function toggleConfirm() {
          const hasPay  = !!(payHidden && payHidden.value);
          const hasAddr = !!(addrH && addrH.value);
          if (confirmBtn) confirmBtn.disabled = !(hasPay && hasAddr);
        }

        function syncNoteHidden() {
          if (!noteTA || !noteH) return;
          noteH.value = noteTA.value || '';
        }

        function choosePayment(methodCode) {
          if (payHidden) payHidden.value = methodCode || '';
          if (curLabel)  curLabel.textContent = methodCode || 'Ch∆∞a ch·ªçn';
          if (payWrapper) {
            payWrapper.innerHTML = '';
            payWrapper.dataset.open = '0';
          }
          toggleConfirm();
        }

        function toggleChooser() {
          if (!payWrapper) return;
          if (payWrapper.dataset.open === '1') {
            payWrapper.innerHTML = ''; payWrapper.dataset.open = '0'; return;
          }
          payWrapper.innerHTML = `
            <div class="pay-method" style="margin-bottom:12px">
              <button type="button" class="pay-tile" data-method="COD">COD</button>
              <button type="button" class="pay-tile" data-method="VNPAY">VNPAY</button>
              <button type="button" class="pay-tile" data-method="MOMO">MOMO</button>
            </div>`;
          payWrapper.dataset.open = '1';

          const curr = payHidden && payHidden.value;
          if (curr) [...payWrapper.querySelectorAll('.pay-tile')].forEach(tile => {
            if (tile.getAttribute('data-method') === curr)
              tile.classList.add('is-selected');
          });
          [...payWrapper.querySelectorAll('.pay-tile')].forEach(tile => {
            tile.addEventListener('click', () => choosePayment(tile.getAttribute('data-method')));
          });
          payWrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        if (toggleBtn) toggleBtn.addEventListener('click', toggleChooser);
        if (noteTA) noteTA.addEventListener('input', syncNoteHidden);
        syncNoteHidden();

        // Radio ƒë·ªãa ch·ªâ ‚Üí sync hidden
        const addrRadios = [...document.querySelectorAll('input[name="addressId"]')];
        addrRadios.forEach(r => {
          r.addEventListener('change', () => { addrH.value = r.value; toggleConfirm(); });
          if (r.checked) addrH.value = r.value;
        });

        toggleConfirm();
      });

      // ===== Flash Messages Handler =====
      (() => {
        const toastError = /*[[${toastError}]]*/ null;
        const toastSuccess = /*[[${toastSuccess}]]*/ null;
        
        if (toastError) {
          alert('‚ùå ' + toastError);
        }
        if (toastSuccess) {
          alert('‚úÖ ' + toastSuccess);
        }
      })();
      </script>
  </div>
</html>
