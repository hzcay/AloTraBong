<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  lang="vi"
  th:replace="~{fragments/layout :: layout(~{::content}, 'Trang ch·ªß')}"
>
  <div
    th:fragment="content"
    id="home-root"
    th:attr="data-branch-id=${branchId}"
  >
    <!-- === CSS FIX (ƒë·∫∑t TRONG fragment ƒë·ªÉ ch·∫Øc ch·∫Øn render) === -->
    <style>
      /* Fix click tabs & card overlay */
      [data-tabs] .tab {
        pointer-events: auto !important;
        cursor: pointer;
      }
      [data-tabs] {
        position: relative;
        z-index: 5;
      }
      .product-card {
        position: relative;
        z-index: 1;
      }
      .gradient-hero {
        position: relative;
        z-index: 0;
      }
      .page-overlay[hidden],
      .page-overlay[aria-hidden="true"] {
        pointer-events: none !important;
      }
    </style>

    <!-- HERO -->
    <section
      class="gradient-hero"
      style="padding: 48px 0; border-bottom: 2px solid #000"
    >
      <div
        class="container"
        style="
          display: grid;
          grid-template-columns: 1.15fr 0.85fr;
          gap: 28px;
          align-items: center;
        "
      >
        <div>
          <p style="margin: 0 0 6px; color: #222">
            Xin ch√†o,
            <b th:text="${userName} ?: 'Ng∆∞·ªùi d√πng VIP'">Ng∆∞·ªùi d√πng VIP</b> üëã
          </p>
          <h1
            style="
              font-size: 42px;
              line-height: 1.1;
              margin: 0 0 12px;
              font-weight: 900;
              text-transform: uppercase;
            "
          >
            EAT FAST. LIVE HAPPY.
          </h1>
          <p style="color: #222; max-width: 560px">
            M√≥n n√≥ng h·ªïi ‚Äì ƒë·∫∑t l√† c√≥. Giao nhanh, ngon chu·∫©n, gi√° ·ªïn √°p.
          </p>
          <div style="margin-top: 16px; display: flex; gap: 12px">
            <a th:href="@{/menu}" class="btn btn-primary">ƒê·∫∑t ngay</a>
            <a th:href="@{/coupons}" class="btn">∆Øu ƒë√£i h√¥m nay</a>
          </div>
        </div>
        <div class="card" style="padding: 16px; background: #fff8f1">
          <img
            th:src="@{/img/hero-food.jpg}"
            src="/img/hero-food.jpg"
            alt="M√≥n n·ªïi b·∫≠t"
            style="width: 100%; border-radius: 8px"
          />
        </div>
      </div>
    </section>

    <!-- TABS DANH M·ª§C -->
    <section class="container" style="padding: 26px 0">
      <header
        style="
          display: flex;
          justify-content: space-between;
          align-items: end;
          margin-bottom: 12px;
        "
      >
        <h2
          style="
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            margin: 0;
          "
        >
          Kh√°m ph√° m√≥n ngon
        </h2>
        <a th:href="@{/menu}" class="btn">Xem Menu</a>
      </header>

      <!-- tab controls -->
      <div
        data-tabs="home"
        style="
          display: flex;
          gap: 14px;
          border-bottom: 1px solid var(--line);
          margin-bottom: 14px;
        "
      >
        <button type="button" class="tab is-active" data-tab="new">
          M√≥n m·ªõi
        </button>
        <button type="button" class="tab" data-tab="best">B√°n ch·∫°y</button>
        <button type="button" class="tab" data-tab="fav">ƒê∆∞·ª£c y√™u th√≠ch</button>
      </div>

      <!-- panel: NEW -->
      <div data-panel="new">
        <div
          data-role="grid-new"
          style="
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 18px;
          "
        >
          <article
            class="card product-card"
            style="padding: 12px; cursor: pointer"
            th:each="p : ${productsNew}"
            th:attr="data-href=@{'/user/product/detail/' + ${p.id}}"
          >
            <img
              th:src="${p.thumbnailUrl}"
              alt=""
              style="width: 100%; border-radius: 8px"
              onerror="this.onerror=null;this.src='/img/placeholder.jpg'"
            />
            <h3
              style="font-weight: 800; margin: 10px 0 4px"
              th:text="${p.name}"
            >
              T√™n m√≥n
            </h3>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <strong
                th:text="${#numbers.formatDecimal(p.price,0,'POINT',0,'COMMA')} + 'ƒë'"
                >49.000ƒë</strong
              >
              <button
                class="btn add-to-cart"
                type="button"
                th:attr="data-id=${p.id}"
              >
                + Gi·ªè
              </button>
            </div>
          </article>
        </div>

        <div
          th:if="${#lists.isEmpty(productsNew)}"
          style="padding: 16px; color: var(--ink-2)"
        >
          Ch∆∞a c√≥ m√≥n m·ªõi. Quay l·∫°i sau nha!
        </div>

        <div style="display: flex; justify-content: center; margin-top: 14px">
          <button type="button" class="btn load-more" data-load="new">
            Xem th√™m
          </button>
        </div>
      </div>

      <!-- panel: BEST -->
      <div data-panel="best" hidden>
        <div
          data-role="grid-best"
          style="
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 18px;
          "
        >
          <article
            class="card product-card"
            style="padding: 12px; cursor: pointer"
            th:each="p : ${productsBest}"
            th:attr="data-href=@{'/user/product/detail/' + ${p.id}}"
          >
            <img
              th:src="${p.thumbnailUrl}"
              alt=""
              style="width: 100%; border-radius: 8px"
              onerror="this.onerror=null;this.src='/img/placeholder.jpg'"
            />
            <h3
              style="font-weight: 800; margin: 10px 0 4px"
              th:text="${p.name}"
            >
              T√™n m√≥n
            </h3>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <strong
                th:text="${#numbers.formatDecimal(p.price,0,'POINT',0,'COMMA')} + 'ƒë'"
                >49.000ƒë</strong
              >
              <button
                class="btn add-to-cart"
                type="button"
                th:attr="data-id=${p.id}"
              >
                + Gi·ªè
              </button>
            </div>
          </article>
        </div>

        <div
          th:if="${#lists.isEmpty(productsBest)}"
          style="padding: 16px; color: var(--ink-2)"
        >
          Ch∆∞a c√≥ d·ªØ li·ªáu b√°n ch·∫°y.
        </div>

        <div style="display: flex; justify-content: center; margin-top: 14px">
          <a th:href="@{/menu(sort='best')}" class="btn">Xem th√™m</a>
        </div>
      </div>

      <!-- panel: FAVORITES -->
      <div data-panel="fav" hidden>
        <div
          data-role="grid-fav"
          style="
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 18px;
          "
        >
          <article
            class="card product-card"
            style="padding: 12px; cursor: pointer"
            th:each="p : ${productsFav}"
            th:attr="data-href=@{'/user/product/detail/' + ${p.id}}"
          >
            <img
              th:src="${p.thumbnailUrl}"
              alt=""
              style="width: 100%; border-radius: 8px"
              onerror="this.onerror=null;this.src='/img/placeholder.jpg'"
            />
            <h3
              style="font-weight: 800; margin: 10px 0 4px"
              th:text="${p.name}"
            >
              T√™n m√≥n
            </h3>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <strong
                th:text="${#numbers.formatDecimal(p.price,0,'POINT',0,'COMMA')} + 'ƒë'"
                >49.000ƒë</strong
              >
              <button
                class="btn add-to-cart"
                type="button"
                th:attr="data-id=${p.id}"
              >
                + Gi·ªè
              </button>
            </div>
          </article>
        </div>

        <div
          th:if="${#lists.isEmpty(productsFav)}"
          style="padding: 16px; color: var(--ink-2)"
        >
          Ch∆∞a c√≥ m√≥n y√™u th√≠ch ƒë·ªÉ hi·ªÉn th·ªã.
        </div>

        <div style="display: flex; justify-content: center; margin-top: 14px">
          <a th:href="@{/menu(filter='favorite')}" class="btn">Xem th√™m</a>
        </div>
      </div>
    </section>

    <!-- ƒê·∫∑t l·∫°i g·∫ßn ƒë√¢y (·∫©n n·∫øu null) -->
    <section
      class="container"
      style="padding: 8px 0 28px"
      th:if="${recentItems != null}"
    >
      <header
        style="
          display: flex;
          justify-content: space-between;
          align-items: end;
          margin-bottom: 12px;
        "
      >
        <h2
          style="
            font-size: 20px;
            font-weight: 900;
            text-transform: uppercase;
            margin: 0;
          "
        >
          ƒê·∫∑t l·∫°i g·∫ßn ƒë√¢y
        </h2>
        <a th:href="@{/orders}" class="btn">Xem ƒë∆°n</a>
      </header>
      <div
        style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px"
      >
        <article
          class="card product-card"
          style="padding: 10px; cursor: pointer"
          th:each="p : ${recentItems}"
          th:attr="data-href=@{'/user/product/detail/' + ${p.id}}"
        >
          <img
            th:src="${p.thumbnailUrl}"
            alt=""
            style="width: 100%; border-radius: 8px"
            onerror="this.onerror=null;this.src='/img/placeholder.jpg'"
          />
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-top: 6px;
            "
          >
            <span style="font-weight: 700" th:text="${p.name}">T√™n m√≥n</span>
            <button
              type="button"
              class="btn add-to-cart"
              th:attr="data-id=${p.id}"
            >
              + Gi·ªè
            </button>
          </div>
        </article>
      </div>
    </section>

    <!-- === JS (PH·∫¢I n·∫±m TRONG fragment) === -->
    <script>
      (function () {
        // ===== Helpers =====
        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

        // Resolve current branchId: meta > data-attr > default "b1"
        const CURRENT_BRANCH_ID =
          document.querySelector('meta[name="branch-id"]')?.content ||
          document.getElementById("home-root")?.dataset.branchId ||
          "b1";

        function toast(msg) {
          let box = $("#_toast_box");
          if (!box) {
            box = document.createElement("div");
            box.id = "_toast_box";
            Object.assign(box.style, {
              position: "fixed",
              right: "16px",
              top: "16px",
              zIndex: 9999,
              display: "grid",
              gap: "8px",
            });
            document.body.appendChild(box);
          }
          const tip = document.createElement("div");
          tip.textContent = msg;
          Object.assign(tip.style, {
            padding: "10px 12px",
            background: "#111",
            color: "#fff",
            borderRadius: "10px",
            boxShadow: "0 6px 18px rgba(0,0,0,.25)",
            fontWeight: 600,
          });
          box.appendChild(tip);
          setTimeout(() => tip.remove(), 1400);
        }

        function buildHeaders() {
          const headers = { "Content-Type": "application/json" };
          const csrf = document.querySelector('meta[name="_csrf"]')?.content;
          const csrfHeader = document.querySelector(
            'meta[name="_csrf_header"]'
          )?.content;
          if (csrf && csrfHeader) headers[csrfHeader] = csrf;
          const jwt = localStorage.getItem("access_token");
          if (jwt) headers["Authorization"] = `Bearer ${jwt}`;
          return headers;
        }

        // ===== API =====
        async function apiAddToCart(
          itemId,
          quantity = 1,
          branchId = CURRENT_BRANCH_ID
        ) {
          const body = { itemId, branchId, quantity: Number(quantity) || 1 };
          const res = await fetch("/api/cart/add", {
            method: "POST",
            headers: buildHeaders(),
            body: JSON.stringify(body),
          });
          if (res.status === 401) {
            location.href = "/auth";
            return;
          }
          if (!res.ok) {
            const txt = await res.text().catch(() => "Add to cart failed");
            throw new Error(txt);
          }
          const payload = await res.json().catch(() => null);
          return payload?.data ?? null;
        }

        // ===== Tabs (event delegation) =====
        function initTabsDelegation() {
          document.addEventListener("click", (e) => {
            const tabBtn = e.target.closest("[data-tabs] .tab");
            if (!tabBtn) return;

            e.preventDefault();
            const key = tabBtn.dataset.tab || "new";
            const bar = tabBtn.closest("[data-tabs]");
            const section = bar.closest("section") || document;

            // toggle active
            $$(".tab", bar).forEach((t) => {
              const act = t === tabBtn;
              t.classList.toggle("is-active", act);
              t.setAttribute("aria-selected", act ? "true" : "false");
              t.setAttribute("tabindex", act ? "0" : "-1");
              if (t.tagName === "BUTTON" && !t.type) t.type = "button";
            });

            // show/hide panels
            ["new", "best", "fav"].forEach((k) => {
              const pane = section.querySelector(`[data-panel="\${k}"]`);
              if (pane) pane.hidden = k !== key;
            });
          });

          // init state
          document.querySelectorAll("[data-tabs]").forEach((bar) => {
            const current =
              (bar.querySelector(".tab.is-active") || bar.querySelector(".tab"))
                ?.dataset.tab || "new";
            const btn =
              bar.querySelector(`.tab[data-tab="\${current}"]`) ||
              bar.querySelector(".tab");
            btn?.dispatchEvent(new Event("click", { bubbles: true }));
          });

          // insurance CSS (n·∫øu theme n√†o ch·∫∑n pointer-events)
          const fix = document.createElement("style");
          fix.textContent =
            "[data-tabs] .tab{pointer-events:auto!important;cursor:pointer}[data-tabs]{position:relative;z-index:5}";
          document.head.appendChild(fix);
        }

        // ===== Card click (event delegation) =====
        function initCardClickDelegation() {
          document.addEventListener("click", (e) => {
            // b·ªè qua control
            if (
              e.target.closest(
                "button, .add-to-cart, a, input, select, textarea, label"
              )
            )
              return;
            const card = e.target.closest(".product-card");
            if (!card) return;
            const href = card.getAttribute("data-href") || card.dataset.href;
            if (!href) return;
            try {
              window.location.href = href;
            } catch {
              window.location.assign(href);
            }
          });
        }

        // ===== Add-to-cart (event delegation) =====
        function initAddToCartDelegation() {
          // ƒë·∫£m b·∫£o n√∫t trong DOM hi·ªán t·∫°i l√† type=button
          $$(".add-to-cart").forEach((b) => {
            if (!b.type) b.type = "button";
          });

          document.addEventListener("click", async (e) => {
            const btn = e.target.closest(".add-to-cart");
            if (!btn) return;

            e.preventDefault();
            if (btn.dataset.loading === "1") return;
            btn.dataset.loading = "1";

            const itemId = btn.dataset.id;
            const original = btn.textContent;
            btn.disabled = true;

            try {
              await apiAddToCart(itemId, 1, CURRENT_BRANCH_ID);
              btn.textContent = "ƒê√£ th√™m ‚úì";
              toast("ƒê√£ th√™m v√†o gi·ªè");
              setTimeout(() => (btn.textContent = original), 1200);
            } catch (err) {
              toast("Th√™m gi·ªè th·∫•t b·∫°i");
              alert("Th√™m gi·ªè th·∫•t b·∫°i: " + err.message);
            } finally {
              btn.disabled = false;
              btn.dataset.loading = "0";
            }
          });
        }

        // ===== Load-more =====
        function vnMoney(x) {
          try {
            if (x == null) return "Li√™n h·ªá";
            const n = Number(x);
            return (isNaN(n) ? "Li√™n h·ªá" : n.toLocaleString("vi-VN")) + "ƒë";
          } catch {
            return "Li√™n h·ªá";
          }
        }

        function cardHtml(p) {
          const img = p.thumbnailUrl || "/img/placeholder.jpg";
          return `
            <article class="card product-card" style="padding: 12px; cursor: pointer"
                     data-href="/user/product/detail/${p.id}">
              <img src="${img}" alt="" style="width: 100%; border-radius: 8px"
                   onerror="this.onerror=null;this.src='/img/placeholder.jpg'"/>
              <h3 style="font-weight: 800; margin: 10px 0 4px">${p.name ?? ""}</h3>
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <strong>${vnMoney(p.price)}</strong>
                <button class="btn add-to-cart" type="button" data-id="${p.id}">+ Gi·ªè</button>
              </div>
            </article>`;
        }

        async function loadMore(type, gridEl, btn) {
          if (!type || !gridEl) return;
          btn && (btn.disabled = true);

          try {
            const res = await fetch(
              `/user/home/more?type=${encodeURIComponent(type)}&size=1000`,
              { headers: { Accept: "application/json" } }
            );
            if (!res.ok) throw new Error("Fetch failed");
            const data = await res.json();

            // L·ªçc b·ªè nh·ªØng m√≥n ƒë√£ c√≥ (theo data-href trong DOM)
            const existed = new Set(
              Array.from(gridEl.querySelectorAll("[data-href]")).map((el) =>
                (el.getAttribute("data-href") || "").split("/").pop()
              )
            );

            const fresh = (data.items || []).filter((it) => !existed.has(it.id));
            if (!fresh.length) {
              btn && (btn.textContent = "ƒê√£ hi·ªÉn th·ªã h·∫øt");
              return;
            }

            // Append b·∫±ng DocumentFragment
            const frag = document.createDocumentFragment();
            const wrapper = document.createElement("div");
            wrapper.innerHTML = fresh.map(cardHtml).join("");
            while (wrapper.firstChild) frag.appendChild(wrapper.firstChild);
            gridEl.appendChild(frag);

            btn && (btn.textContent = "Xem th√™m n·ªØa");
          } catch (e) {
            alert("T·∫£i th√™m th·∫•t b·∫°i");
          } finally {
            btn && (btn.disabled = false);
          }
        }

        function initLoadMoreDelegation() {
          document.addEventListener("click", (e) => {
            const btn = e.target.closest(".load-more");
            if (!btn) return;
            e.preventDefault();

            const type = btn.dataset.load; // 'new' | 'best' | 'fav'
            // t√¨m grid trong ƒë√∫ng panel ch·ª©a n√∫t
            const panel = btn.closest("[data-panel]");
            const grid =
              panel?.querySelector('[data-role="grid-' + type + '"]') ||
              document.querySelector('[data-role="grid-' + type + '"]');

            loadMore(type, grid, btn);
          });
        }

        // ===== Boot =====
        function boot() {
          initTabsDelegation();
          initCardClickDelegation();
          initAddToCartDelegation();
          initLoadMoreDelegation();
        }
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", boot);
        } else {
          boot();
        }
      })();
    </script>
  </div>
</html>
